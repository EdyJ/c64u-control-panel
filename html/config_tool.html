<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Configuration Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/jquery"></script>
    <style>
        :root { 
            --primary: #3498db; 
            --success: #2ecc71; 
            --danger: #e74c3c; 
            --warning: #f39c12;
            --bg: #1a1c1e; 
            --card-bg: #25282c; 
            --text: #e0e0e0;
            --text-dim: #a0a0a0;
            --border: #3a3f44;
            --input-bg: #2d3136;
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg); 
            margin: 0; 
            padding: 20px; 
            color: var(--text); 
        }
        .container { max-width: 1000px; margin: 0 auto; }
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            border-bottom: 2px solid var(--primary); 
            padding-bottom: 10px; 
        }
        h1 { margin: 0; font-size: 24px; color: var(--primary); }
        .back-link { font-size: 12px; color: var(--text-dim); text-decoration: none; margin-top: 5px; display: inline-block; }
        .back-link:hover { color: var(--primary); }
        
        /* Search Box */
        .search-box {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }
        .search-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .search-controls input {
            flex: 1;
            padding: 10px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            color: var(--text);
        }
        .search-controls input:focus { outline: none; border-color: var(--primary); }
        .search-controls button {
            padding: 10px 15px;
            background: #5a6268;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
        }
        .search-controls button:hover { opacity: 0.8; }
        .search-hint {
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 5px;
        }

        /* Configuration Management */
        .config-mgmt-box {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }
        .control-title {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .config-mgmt-box button {
            padding: 10px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
        }
        .config-mgmt-box button:hover { opacity: 0.8; }

        /* Collapse/Expand All */
        .section-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: flex-end;
        }
        .section-controls button {
            padding: 8px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
        }
        .section-controls button:hover { opacity: 0.8; }

        /* Foldable Sections */
        .section { 
            background: var(--card-bg); 
            border-radius: 8px; 
            border: 1px solid var(--border); 
            margin-bottom: 15px; 
            overflow: hidden; 
        }
        .section.hidden { display: none; }
        .item.hidden { display: none; }
        .section-header { 
            background: #2c3136; 
            padding: 12px 15px; 
            font-weight: bold; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            color: var(--primary);
            border-bottom: 1px solid var(--border);
        }
        .section-header:hover { background: #32383e; }
        .section-header .arrow { transition: opacity 0.2s; }
        .section-header .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid var(--text-dim);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
        }
        .section-header .item-count {
            color: var(--text-dim);
            font-weight: normal;
            font-size: 13px;
            margin-left: 5px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .section-content { 
            padding: 0;
            display: none; 
        }
        .section-content.loading {
            display: block;
            text-align: center;
            color: var(--text-dim);
            font-style: italic;
            padding: 20px;
        }

        /* Config Items - Compact Row Style */
        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .config-item:last-child {
            border-bottom: none;
        }
        .config-item.hidden { display: none; }
        .config-item-name {
            font-weight: bold;
            color: var(--text);
            flex: 1;
            margin-right: 15px;
        }
        .config-item-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .config-item input[type="text"],
        .config-item input[type="number"],
        .config-item select {
            padding: 6px 10px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 13px;
            color: var(--text);
            min-width: 150px;
        }
        .config-item input:focus,
        .config-item select:focus {
            outline: none;
            border-color: var(--primary);
        }
        .config-item .modify-btn {
            padding: 6px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            display: none;
        }
        .config-item .modify-btn.visible {
            display: inline-block;
        }
        .config-item .modify-btn:hover {
            opacity: 0.8;
        }
        .config-item .revert-btn {
            padding: 6px 12px;
            background: var(--warning);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            display: none;
        }
        .config-item .revert-btn.visible {
            display: inline-block;
        }
        .config-item .revert-btn:hover {
            opacity: 0.8;
        }
        .config-item .success-check {
            color: var(--success);
            font-size: 16px;
            font-weight: bold;
            display: none;
        }
        .config-item .success-check.visible {
            display: inline-block;
        }
        .config-item-error {
            padding: 8px 15px;
            background: rgba(231, 76, 60, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
            border-radius: 4px;
            font-size: 12px;
            margin: 5px 15px;
            display: none;
        }
        .config-item-error.visible {
            display: block;
        }

        input[type="password"] { 
            padding: 8px; 
            background: var(--input-bg); 
            border: 1px solid var(--border); 
            border-radius: 4px; 
            font-size: 13px; 
            color: var(--text);
            width: 150px;
        }
        input[type="password"]:focus { outline: none; border-color: var(--primary); }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>Ultimate Configuration Tool</h1>
                <a href="index.html" class="back-link">← Back to Control Panel</a>
            </div>
            <div>
                <form autocomplete="on">
                    <input type="text" name="username" value="ultimate-api" autocomplete="username" style="display: none;">
                    <input type="password" id="apiPassword" name="ultimate-api-password" placeholder="API Password" autocomplete="current-password" style="font-family: monospace;">
                </form>
            </div>
        </header>

        <!-- Search and Config Management Row -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <!-- Search Box -->
            <div class="search-box">
                <div class="search-controls">
                    <input type="text" id="searchInput" placeholder="Search items...">
                    <button id="clearSearch">Clear</button>
                </div>
                <div class="search-hint">Type 2+ letters to search. Multiple terms refine results.</div>
            </div>

            <!-- Configuration Management -->
            <div class="config-mgmt-box">
                <div class="control-title" style="margin-bottom: 10px;">Configuration Management</div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button id="saveToFlash" title="Write current configuration to non-volatile memory" style="flex: 1; background: var(--success);">Save To Flash</button>
                    <button id="loadFromFlash" title="Restore configuration from non-volatile memory" style="flex: 1; background: #f39c12;">Load From Flash</button>
                    <button id="resetToDefault" title="Reset settings to factory default (does not clear flash)" style="flex: 1; background: var(--danger);">Reset To Default</button>
                </div>
                <div class="result-box" id="configMgmtResult" style="margin-top: 10px; display: none;"></div>
            </div>
        </div>

        <!-- Section Controls -->
        <div class="section-controls">
            <button id="reloadBtn" onclick="reloadInterface()">Reload</button>
            <button id="expandAll">Expand All</button>
            <button id="collapseAll">Collapse All</button>
        </div>

        <div id="categories-container">
            <div class="loading-indicator" style="text-align: center; padding: 20px; color: var(--text-dim); font-style: italic;">Loading configuration...</div>
        </div>
    </div>

    <script>
        let configData = {}; // Stores all category and item data
        let searchTerms = [];

        function getPassword() {
            return $('#apiPassword').val();
        }

        function encodeCategory(str) {
            return encodeURIComponent(str);
        }

        // Load all categories and their items asynchronously
        async function loadAllConfig() {
            try {
                // First, get all categories
                const categoriesResponse = await $.ajax({
                    url: '/v1/configs',
                    method: 'GET',
                    headers: { "X-Password": getPassword() }
                });

                if (!categoriesResponse || !categoriesResponse.categories) {
                    throw new Error('Invalid categories response');
                }

                const categories = categoriesResponse.categories;
                
                // Render categories immediately
                renderCategories(categories);

                // Load each category's items asynchronously
                for (const category of categories) {
                    loadCategoryData(category);
                }
            } catch (error) {
                $('#categories-container').html(`<div style="text-align: center; padding: 20px; color: var(--danger);">Error loading configuration: ${error.message}</div>`);
            }
        }

        function renderCategories(categories) {
            const $container = $('#categories-container');
            $container.empty();

            categories.forEach(category => {
                configData[category] = { loaded: false, items: {} };
                
                const $section = $(`
                    <div class="section" data-category="${category}">
                        <div class="section-header">
                            <span class="category-title">${category}</span>
                            <div>
                                <span class="spinner"></span>
                                <span class="arrow">▼</span>
                            </div>
                        </div>
                        <div class="section-content"></div>
                    </div>
                `);
                $container.append($section);
            });

            // Add click handlers
            $('.section-header').click(function() {
                const $header = $(this);
                const $section = $header.parent();
                const $content = $header.next('.section-content');
                const category = $section.data('category');

                if ($header.hasClass('open')) {
                    // Close section
                    $content.slideUp(300, function() {
                        $header.removeClass('open');
                        $header.find('.arrow').text('▼');
                    });
                } else {
                    // Open section
                    $header.addClass('open');
                    $header.find('.arrow').text('▲');
                    
                    if (configData[category].loaded) {
                        // Already loaded, render and show
                        if ($content.children().length === 0) {
                            renderCategoryItems(category);
                        }
                        $content.slideDown(300);
                    } else {
                        // Show loading state
                        $content.removeClass('loading').addClass('loading').text('Loading...').slideDown(300);
                    }
                }
            });
        }

        async function loadCategoryData(category) {
            const encodedCategory = encodeCategory(category);
            
            try {
                // Get category items
                const itemsResponse = await $.ajax({
                    url: `/v1/configs/${encodedCategory}`,
                    method: 'GET',
                    headers: { "X-Password": getPassword() }
                });

                const items = itemsResponse[category];
                if (!items) {
                    throw new Error('Invalid items response');
                }

                // Get detailed info for each item
                const itemNames = Object.keys(items);
                for (const itemName of itemNames) {
                    await loadItemDetails(category, itemName);
                }

                configData[category].loaded = true;
                
                // Remove spinner and add item count
                const $section = $(`.section[data-category="${category}"]`);
                $section.find('.spinner').remove();
                const itemCount = Object.keys(configData[category].items).length;
                $section.find('.category-title').append(`<span class="item-count">(${itemCount})</span>`);
                
                // Always render items (even when closed) so search can work
                const $content = $section.find('.section-content');
                $content.removeClass('loading');
                renderCategoryItems(category);
                
                // If section is open, show the content
                const $header = $section.find('.section-header');
                if ($header.hasClass('open')) {
                    $content.slideDown(300);
                }
                
                // Apply search filter if active
                applySearchFilter();
            } catch (error) {
                configData[category].loaded = true;
                configData[category].error = error.message;
                $(`.section[data-category="${category}"] .spinner`).remove();
                
                const $section = $(`.section[data-category="${category}"]`);
                const $header = $section.find('.section-header');
                if ($header.hasClass('open')) {
                    $section.find('.section-content').removeClass('loading').html(`<div style="color: var(--danger); text-align: center; padding: 20px;">Error: ${error.message}</div>`);
                }
            }
        }

        async function loadItemDetails(category, itemName) {
            const encodedCategory = encodeCategory(category);
            const encodedItem = encodeCategory(itemName);
            
            try {
                const detailsResponse = await $.ajax({
                    url: `/v1/configs/${encodedCategory}/${encodedItem}`,
                    method: 'GET',
                    headers: { "X-Password": getPassword() }
                });

                const itemDetails = detailsResponse[category][itemName];
                configData[category].items[itemName] = itemDetails;
            } catch (error) {
                configData[category].items[itemName] = { error: error.message };
            }
        }

        function renderCategoryItems(category) {
            const $content = $(`.section[data-category="${category}"] .section-content`);
            
            // Only render if not already rendered
            if ($content.children().length > 0) {
                return;
            }
            
            $content.empty();

            const items = configData[category].items;
            const itemNames = Object.keys(items);

            if (itemNames.length === 0) {
                $content.html('<div style="color: var(--text-dim); text-align: center; padding: 20px;">No items found</div>');
                return;
            }

            itemNames.forEach(itemName => {
                const itemData = items[itemName];
                const $item = createItemControl(category, itemName, itemData);
                $content.append($item);
            });
        }

        function createItemControl(category, itemName, itemData) {
            if (itemData.error) {
                return $(`<div class="config-item" data-item="${itemName}">
                    <div class="config-item-name">${itemName}</div>
                    <div style="color: var(--danger); font-size: 12px;">Error: ${itemData.error}</div>
                </div>`);
            }

            const $item = $('<div class="config-item"></div>').attr('data-item', itemName);
            const $name = $(`<div class="config-item-name">${itemName}</div>`);
            const $controls = $('<div class="config-item-controls"></div>');

            let $input;
            const currentValue = itemData.current;
            
            // Determine control type based on item data
            if (itemData.values && Array.isArray(itemData.values)) {
                // Dropdown for items with predefined values
                $input = $('<select></select>');
                itemData.values.forEach(value => {
                    const $option = $(`<option value="${value}">${value}</option>`);
                    if (value === itemData.current) {
                        $option.prop('selected', true);
                    }
                    $input.append($option);
                });
            } else if (typeof itemData.min !== 'undefined' && typeof itemData.max !== 'undefined') {
                // Numeric input for items with min/max
                $input = $('<input type="number">');
                $input.attr('min', itemData.min);
                $input.attr('max', itemData.max);
                $input.val(itemData.current);
                if (itemData.format) {
                    $input.attr('placeholder', itemData.format);
                }
            } else {
                // Text input for other items
                $input = $('<input type="text">');
                $input.val(itemData.current);
            }
            
            // Add tooltip showing default value
            if (typeof itemData.default !== 'undefined') {
                $input.attr('title', `Default: ${itemData.default}`);
            }

            const $modifyBtn = $('<button class="modify-btn">Modify</button>');
            const $revertBtn = $('<button class="revert-btn">Revert</button>');
            const $successCheck = $('<span class="success-check">✓</span>');
            const $errorBox = $('<div class="config-item-error"></div>');

            // Show Modify/Revert buttons when value changes
            $input.on('change input', function() {
                const newValue = $(this).val();
                const currentValue = String(itemData.current);
                if (newValue !== currentValue) {
                    $modifyBtn.addClass('visible');
                    $revertBtn.addClass('visible');
                } else {
                    $modifyBtn.removeClass('visible');
                    $revertBtn.removeClass('visible');
                }
                $successCheck.removeClass('visible');
                $errorBox.removeClass('visible');
            });

            // Modify button click handler
            $modifyBtn.click(function() {
                const newValue = $input.val();
                modifyConfigItem(category, itemName, newValue, $modifyBtn, $revertBtn, $successCheck, $errorBox, itemData);
            });

            // Revert button click handler
            $revertBtn.click(async function() {
                $revertBtn.prop('disabled', true).text('Reverting...');
                $modifyBtn.prop('disabled', true);
                $errorBox.removeClass('visible');
                
                try {
                    // Fetch current value from API
                    const encodedCategory = encodeCategory(category);
                    const encodedItem = encodeCategory(itemName);
                    const response = await $.ajax({
                        url: `/v1/configs/${encodedCategory}/${encodedItem}`,
                        method: 'GET',
                        headers: { "X-Password": getPassword() }
                    });
                    
                    const itemDetails = response[category][itemName];
                    const currentValueFromAPI = itemDetails.current;
                    
                    // Update input with current value
                    $input.val(currentValueFromAPI);
                    
                    // Update cached value
                    itemData.current = currentValueFromAPI;
                    
                    // Hide buttons and feedback
                    $modifyBtn.removeClass('visible').prop('disabled', false);
                    $revertBtn.removeClass('visible').prop('disabled', false).text('Revert');
                    $successCheck.removeClass('visible');
                } catch (error) {
                    const errorMsg = error.responseJSON && error.responseJSON.errors ? 
                        error.responseJSON.errors.join(', ') : 
                        error.message || 'Failed to fetch current value';
                    
                    $errorBox.text(`Error: ${errorMsg}`).addClass('visible');
                    $revertBtn.prop('disabled', false).text('Revert');
                    $modifyBtn.prop('disabled', false);
                }
            });

            // Buttons first, then input, then success check
            $controls.append($modifyBtn);
            $controls.append($revertBtn);
            $controls.append($input);
            $controls.append($successCheck);
            $item.append($name);
            $item.append($controls);
            
            // Add error box after the item row
            const $wrapper = $('<div class="item"></div>');
            $wrapper.append($item);
            $wrapper.append($errorBox);

            return $wrapper;
        }

        async function modifyConfigItem(category, itemName, newValue, $modifyBtn, $revertBtn, $successCheck, $errorBox, itemData) {
            const encodedCategory = encodeCategory(category);
            const encodedItem = encodeCategory(itemName);
            
            $modifyBtn.prop('disabled', true).text('Saving...');
            $revertBtn.prop('disabled', true);
            $successCheck.removeClass('visible');
            $errorBox.removeClass('visible');

            try {
                const response = await $.ajax({
                    url: `/v1/configs/${encodedCategory}/${encodedItem}?value=${encodeURIComponent(newValue)}`,
                    method: 'PUT',
                    headers: { "X-Password": getPassword() }
                });

                if (response.errors && response.errors.length > 0) {
                    throw new Error(response.errors.join(', '));
                }

                // Update cached value
                itemData.current = newValue;
                
                $successCheck.addClass('visible');
                $modifyBtn.removeClass('visible').prop('disabled', false).text('Modify');
                $revertBtn.removeClass('visible').prop('disabled', false);
            } catch (error) {
                const errorMsg = error.responseJSON && error.responseJSON.errors ? 
                    error.responseJSON.errors.join(', ') : 
                    error.message || 'Unknown error';
                
                $errorBox.text(`Error: ${errorMsg}`).addClass('visible');
                $modifyBtn.prop('disabled', false).text('Modify');
                $revertBtn.prop('disabled', false);
            }
        }

        // Search functionality
        function applySearchFilter() {
            // Remove any existing no results message
            $('#no-results-message').remove();
            
            if (searchTerms.length === 0) {
                // Show all
                $('.section').removeClass('hidden');
                $('.item').removeClass('hidden');
                return;
            }

            // Filter sections and items
            $('.section').each(function() {
                const $section = $(this);
                const category = $section.data('category');
                const $header = $section.find('.section-header');
                
                if (!configData[category].loaded) {
                    // Skip sections that haven't loaded yet
                    return;
                }

                // Check if section name matches
                const categoryLower = category.toLowerCase();
                const sectionMatches = searchTerms.every(term => categoryLower.includes(term));

                let hasVisibleItems = false;

                // Check items - only show matching items
                $section.find('.item').each(function() {
                    const $wrapper = $(this);
                    const $item = $wrapper.find('.config-item');
                    const itemName = $item.data('item');
                    
                    if (!itemName) return;
                    
                    const itemNameLower = itemName.toLowerCase();
                    const itemMatches = searchTerms.every(term => itemNameLower.includes(term));

                    // Show item only if it matches
                    if (itemMatches) {
                        $wrapper.removeClass('hidden');
                        hasVisibleItems = true;
                    } else {
                        $wrapper.addClass('hidden');
                    }
                });

                // Determine section visibility and state
                if (hasVisibleItems) {
                    // Has matching items - show section expanded with items
                    $section.removeClass('hidden');
                    // Auto-expand if not already open
                    if (!$header.hasClass('open')) {
                        $header.click();
                    }
                } else if (sectionMatches) {
                    // Section name matches but no items match - show section FOLDED with all items visible
                    $section.removeClass('hidden');
                    // Remove hidden class from all items so they're visible when expanded
                    $section.find('.item').removeClass('hidden');
                    // Ensure section is closed
                    if ($header.hasClass('open')) {
                        $header.click();
                    }
                } else {
                    // No match at all - hide section
                    $section.addClass('hidden');
                }
            });
            
            // Check if any sections are visible
            const visibleSections = $('.section:not(.hidden)').length;
            if (visibleSections === 0) {
                // Show no results message
                const $noResults = $('<div id="no-results-message" style="text-align: center; padding: 40px; color: var(--text-dim); font-style: italic; font-size: 16px;">No results found for "' + searchTerms.join(' ') + '"</div>');
                $('#categories-container').append($noResults);
            }
        }

        $('#searchInput').on('input', function() {
            const searchText = $(this).val().trim().toLowerCase();
            
            if (searchText.length < 2) {
                // Reset
                searchTerms = [];
                applySearchFilter();
                return;
            }

            // Split search into terms
            searchTerms = searchText.split(/\s+/).filter(t => t.length >= 2);
            applySearchFilter();
        });

        $('#clearSearch').click(function() {
            $('#searchInput').val('');
            searchTerms = [];
            applySearchFilter();
        });

        $('#expandAll').click(function() {
            $('.section').each(function() {
                const $section = $(this);
                const $header = $section.find('.section-header');
                if (!$header.hasClass('open')) {
                    $header.click();
                }
            });
        });

        $('#collapseAll').click(function() {
            $('.section').each(function() {
                const $section = $(this);
                const $header = $section.find('.section-header');
                if ($header.hasClass('open')) {
                    $header.click();
                }
            });
        });

        // Configuration Management Functions
        function showConfigMgmtResult(msg, isError = false) {
            const $box = $('#configMgmtResult');
            $box.show().text(msg).css('color', isError ? 'var(--danger)' : '#7fdbff');
        }

        function reloadInterface() {
            // Clear existing data and UI
            configData = {};
            $('#categories-container').html('<div class="loading-indicator" style="text-align: center; padding: 20px; color: var(--text-dim); font-style: italic;">Loading configuration...</div>');
            // Reload from scratch
            loadAllConfig();
        }

        async function reloadAllConfig() {
            // Clear existing data and UI
            configData = {};
            $('#categories-container').html('<div class="loading-indicator" style="text-align: center; padding: 20px; color: var(--text-dim); font-style: italic;">Loading configuration...</div>');
            // Reload from scratch
            await loadAllConfig();
            showConfigMgmtResult('Configuration reloaded successfully.');
        }

        $('#saveToFlash').click(async function() {
            if (!confirm('Save current configuration to flash memory?\n\nThis will write the current settings to non-volatile memory.')) {
                return;
            }

            const $btn = $(this);
            $btn.prop('disabled', true).css('opacity', '0.5');
            showConfigMgmtResult('Saving to flash...');

            try {
                await $.ajax({
                    url: '/v1/configs:save_to_flash',
                    method: 'PUT',
                    headers: { "X-Password": getPassword() }
                });
                showConfigMgmtResult('✓ Configuration saved to flash successfully.');
            } catch (error) {
                const errorMsg = error.responseJSON && error.responseJSON.errors ? 
                    error.responseJSON.errors.join(', ') : 
                    error.message || 'Failed to save to flash';
                showConfigMgmtResult(`Error: ${errorMsg}`, true);
            } finally {
                $btn.prop('disabled', false).css('opacity', '1');
            }
        });

        $('#loadFromFlash').click(async function() {
            if (!confirm('Load configuration from flash memory?\n\nThis will restore settings from non-volatile memory and reload the interface.')) {
                return;
            }

            const $btn = $(this);
            $btn.prop('disabled', true).css('opacity', '0.5');
            showConfigMgmtResult('Loading from flash...');

            try {
                await $.ajax({
                    url: '/v1/configs:load_from_flash',
                    method: 'PUT',
                    headers: { "X-Password": getPassword() }
                });
                showConfigMgmtResult('Configuration loaded from flash. Reloading interface...');
                setTimeout(() => reloadAllConfig(), 500);
            } catch (error) {
                // 502 status means device is reloading - treat as success
                if (error.status === 502) {
                    showConfigMgmtResult('Configuration loaded from flash. Reloading interface...');
                    setTimeout(() => reloadAllConfig(), 1000);
                } else {
                    const errorMsg = error.responseJSON && error.responseJSON.errors ? 
                        error.responseJSON.errors.join(', ') : 
                        error.message || 'Failed to load from flash';
                    showConfigMgmtResult(`Error: ${errorMsg}`, true);
                }
            } finally {
                $btn.prop('disabled', false).css('opacity', '1');
            }
        });

        $('#resetToDefault').click(async function() {
            if (!confirm('Reset all settings to factory defaults?\n\nThis will reset all configuration values to their defaults and reload the interface.\n\nNote: This does NOT clear values stored in flash memory.')) {
                return;
            }

            const $btn = $(this);
            $btn.prop('disabled', true).css('opacity', '0.5');
            showConfigMgmtResult('Resetting to defaults...');

            try {
                await $.ajax({
                    url: '/v1/configs:reset_to_default',
                    method: 'PUT',
                    headers: { "X-Password": getPassword() }
                });
                showConfigMgmtResult('Configuration reset to defaults. Reloading interface...');
                setTimeout(() => reloadAllConfig(), 500);
            } catch (error) {
                // 502 status means device is reloading - treat as success
                if (error.status === 502) {
                    showConfigMgmtResult('Configuration reset to defaults. Reloading interface...');
                    setTimeout(() => reloadAllConfig(), 1000);
                } else {
                    const errorMsg = error.responseJSON && error.responseJSON.errors ? 
                        error.responseJSON.errors.join(', ') : 
                        error.message || 'Failed to reset to defaults';
                    showConfigMgmtResult(`Error: ${errorMsg}`, true);
                }
            } finally {
                $btn.prop('disabled', false).css('opacity', '1');
            }
        });

        // Initialize
        $(document).ready(function() {
            loadAllConfig();
        });
    </script>
</body>
</html>
