<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate API Debug Tool</title>
    <link rel="stylesheet" href="css/common.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <!-- CommonJS shim for 6502-reasm library -->
    <script>
        var module = { exports: {} };
    </script>
    
    <!-- Load 6502-reasm library from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/6502-reasm@1.0.0/6502.min.js"></script>
    
    <!-- Make library globally accessible -->
    <script>
        window.reasm6502 = module.exports;
    </script>
    
    <!-- Sequential Script Loader - Loads external JS files one at a time -->
    <script>
    (function() {
        'use strict';
        
        var requiredScripts = [
            'js/ui-components.js',
            'js/api-client.js',
            'js/tab-lifecycle.js'
        ];
        
        var contentItems = [
            '.viewer-content',
            '.tab-bar'
        ];
        
        var currentIndex = 0;
        var syntaxErrorDetected = false;
        
        function showSpinner() {
            var spinner = document.getElementById('spinner');
            if (spinner) spinner.style.display = 'inline-block';
        }
        
        function hideSpinner() {
            var spinner = document.getElementById('spinner');
            if (spinner) spinner.style.display = 'none';
        }
        
        function disableContent() {
            contentItems.forEach(function(selector) {
                var element = document.querySelector(selector);
                if (element) element.classList.add('content-disabled');
            });
        }
        
        function enableContent() {
            contentItems.forEach(function(selector) {
                var element = document.querySelector(selector);
                if (element) element.classList.remove('content-disabled');
            });
        }
        
        function showError() {
            hideSpinner();
            // Keep content disabled
            
            var span = document.createElement('span');
            span.textContent = '❌ Failed to fetch the page from the device. Please reload.';
            span.style.cssText = 'color: #e74c3c; font-weight: bold; font-size: 14px; margin-right: 25px;';
            
            var headerActions = document.querySelector('.header-actions');
            if (headerActions) {
                headerActions.insertBefore(span, headerActions.firstChild);
            }
        }
        
        function loadNextScript() {
            // All scripts loaded
            if (currentIndex >= requiredScripts.length) {
                hideSpinner();
                enableContent();
                
                if (typeof window.initializeApp === 'function') {
                    window.initializeApp();
                }
                return;
            }
            
            var url = requiredScripts[currentIndex];
            
            var script = document.createElement('script');
            script.src = url;
            
            syntaxErrorDetected = false;
            
            // Syntax error handler
            var errorHandler = function(event) {
                if (event.filename && event.filename.includes(url)) {
                    console.error('✗ Syntax error in ' + url);
                    syntaxErrorDetected = true;
                }
            };
            window.addEventListener('error', errorHandler);
            
            script.onload = function() {
                setTimeout(function() {
                    window.removeEventListener('error', errorHandler);
                    
                    if (syntaxErrorDetected) {
                        console.error('✗ Failed to load ' + url);
                        showError();
                    } else {
                        currentIndex++;
                        loadNextScript();
                    }
                }, 100);
            };
            
            script.onerror = function() {
                console.error('✗ Network error loading ' + url);
                window.removeEventListener('error', errorHandler);
                showError();
            };
            
            document.head.appendChild(script);
        }
        
        $(document).ready(function() {
            setTimeout(function() {
                // Check HTML complete
                if (typeof window.initializeApp !== 'function') {
                    location.reload(true);
                    return;
                }
                
                showSpinner();
                disableContent();
                loadNextScript();
            }, 50);
        });
        
    })();
    </script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div>
                <h1>Ultimate API Debug Tool</h1>
                <a href="/" class="back-link">← Back to Control Panel</a>
            </div>
            <div class="header-actions">
                <span id="spinner" class="spinner" style="display:none;"></span>
                <button id="refreshBtn" class="btn-success">Refresh</button>
                <div class="auth-box">
                    <form autocomplete="on">
                        <input type="text" name="username" value="ultimate-api" autocomplete="username" style="display: none;">
                        <input type="password" id="apiPassword" name="password" placeholder="API Password" autocomplete="current-password" class="auth-password-input">
                    </form>
                </div>
            </div>
        </header>
        
        <!-- Error Box -->
        <div id="errorBox"></div>
        
        <!-- Tab Bar -->
        <div class="tab-bar">
            <button class="tab-button active" data-tab="tab1">Debug Viewer 1</button>
            <button class="tab-button" data-tab="tab2">Debug Viewer 2</button>
            <button class="tab-button" data-tab="tab3">Debug Viewer 3</button>
            <button class="tab-button" data-tab="tab4">Disassembler</button>
        </div>
        
        <!-- Debug Viewer 1: Simple Read Test -->
        <div id="tab1-content" class="viewer-content">
            <div class="info-box">
                <strong>Debug Viewer 1</strong><br>
                Tests basic memory reading. Reads 256 bytes from address $0400 (screen memory start).
            </div>
            <button id="debug1-read" class="btn-primary">Test Read Memory ($0400, 256 bytes)</button>
            <div id="debug1-display" class="console-display" style="display:none;"></div>
        </div>
        
        <!-- Debug Viewer 2: Parameterized Read -->
        <div id="tab2-content" class="viewer-content" style="display:none;">
            <div class="info-box">
                <strong>Debug Viewer 2</strong><br>
                Tests parameterized reading. Enter any address and read 16 bytes.
            </div>
            <div class="control-group">
                <label>Address:</label>
                <input type="text" id="debug2-address" value="C000" placeholder="C000">
                <button id="debug2-read" class="btn-primary">Read 16 Bytes</button>
            </div>
            <div id="debug2-display" class="console-display" style="display:none;"></div>
        </div>
        
        <!-- Debug Viewer 3: Write Test with Confirmation -->
        <div id="tab3-content" class="viewer-content" style="display:none;">
            <div class="info-box">
                <strong>Debug Viewer 3</strong><br>
                Tests memory writing and canDeactivate() protocol. Write a byte and try switching tabs - you'll be prompted to confirm.
            </div>
            <div class="control-group">
                <label>Address:</label>
                <input type="text" id="debug3-address" value="0400" placeholder="0400">
                <label>Value:</label>
                <input type="text" id="debug3-value" value="41" placeholder="41" style="width: 60px;">
                <button id="debug3-write" class="btn-primary">Write Byte</button>
            </div>
            <div id="debug3-status" style="margin-top: 15px; color: var(--text-dim);"></div>
            
            <div class="control-group" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                <div style="margin-bottom: 10px; color: var(--text-dim); font-size: 13px;">
                    <strong>POST Write Test (>128 bytes)</strong><br>
                    Tests POST method by writing multiple bytes.
                </div>
                <label>Address:</label>
                <input type="text" id="debug3-post-address" value="D800" placeholder="D800">
                <label>Value:</label>
                <input type="text" id="debug3-post-value" value="00" placeholder="00" style="width: 60px;">
                <label>Count:</label>
                <input type="text" id="debug3-post-count" value="200" placeholder="200" style="width: 60px;">
                <button id="debug3-post-write" class="btn-primary">Write Bytes</button>
            </div>
            <div id="debug3-post-status" style="margin-top: 15px; color: var(--text-dim);"></div>
        </div>
        
        <!-- Debug Viewer 4: 6502 Disassembler -->
        <div id="tab4-content" class="viewer-content" style="display:none;">
            <div class="info-box">
                <strong>6502 Disassembler</strong><br>
                Reads C64 memory and disassembles it to 6502 assembly language.
            </div>
            <div class="control-group">
                <label>Start Address:</label>
                <input type="text" id="disasm-address" value="C000" placeholder="C000">
                <label>Bytes to Read:</label>
                <input type="text" id="disasm-length" value="64" placeholder="64" style="width: 80px;">
                <button id="disasm-read" class="btn-primary">Disassemble</button>
                <button id="disasm-read-formatted" class="btn-primary">Disassemble (Formatted)</button>
            </div>
            <div id="disasm-display" class="console-display" style="display:none;"></div>
            <div id="disasm-display-formatted" class="console-display" style="display:none;"></div>
        </div>
    </div>
    
    <script>
        // ============================================================================
        // SHARED LIBRARIES (ui-components.js, api-client.js, tab-lifecycle.js)
        // ============================================================================
        // All common API methods and UI functions are now in shared libraries
        
        // ============================================================================
        // TAB MANAGEMENT (using tab-lifecycle.js)
        // ============================================================================
        
        const viewerMap = {
            'tab1': 'DebugViewer1',
            'tab2': 'DebugViewer2',
            'tab3': 'DebugViewer3',
            'tab4': 'DisassemblerViewer'
        };
        
        // ============================================================================
        // DEBUG VIEWER 1: Simple Read Test
        // ============================================================================
        
        var DebugViewer1 = {
            initialize: function() {
                console.log('DebugViewer1: initialize()');
                $('#debug1-read').click(() => this.refresh());
            },
            
            activate: function() {
                console.log('DebugViewer1: activate()');
            },
            
            canDeactivate: function() {
                console.log('DebugViewer1: canDeactivate() -> true');
                return true;
            },
            
            deactivate: function() {
                console.log('DebugViewer1: deactivate()');
            },
            
            refresh: function() {
                console.log('DebugViewer1: refresh()');
                const address = 0x0400; // Screen memory
                const length = 256;
                
                readMemory(address, length, (data) => {
                    const bytes = new Uint8Array(data);
                    let output = 'Memory dump from $0400 (256 bytes):\n\n';
                    
                    for (let i = 0; i < bytes.length; i += 16) {
                        const addr = (address + i).toString(16).padStart(4, '0').toUpperCase();
                        output += `$${addr}: `;
                        
                        // Hex bytes
                        for (let j = 0; j < 16 && i + j < bytes.length; j++) {
                            output += bytes[i + j].toString(16).padStart(2, '0').toUpperCase() + ' ';
                        }
                        
                        output += '\n';
                    }
                    
                    $('#debug1-display').text(output).show();
                }, (error) => {
                    $('#debug1-display').text(`Error: ${error}`).show();
                });
            }
        };
        
        // ============================================================================
        // DEBUG VIEWER 2: Parameterized Read
        // ============================================================================
        
        var DebugViewer2 = {
            initialize: function() {
                console.log('DebugViewer2: initialize()');
                $('#debug2-read').click(() => this.refresh());
            },
            
            activate: function() {
                console.log('DebugViewer2: activate()');
            },
            
            canDeactivate: function() {
                console.log('DebugViewer2: canDeactivate() -> true');
                return true;
            },
            
            deactivate: function() {
                console.log('DebugViewer2: deactivate()');
            },
            
            refresh: function() {
                console.log('DebugViewer2: refresh()');
                const addressStr = $('#debug2-address').val().replace(/[^0-9A-Fa-f]/g, '');
                const address = parseInt(addressStr, 16);
                
                if (isNaN(address) || address < 0 || address > 0xFFFF) {
                    showError('Invalid address. Enter hex value (0000-FFFF)');
                    return;
                }
                
                readMemory(address, 16, (data) => {
                    const bytes = new Uint8Array(data);
                    const addr = address.toString(16).padStart(4, '0').toUpperCase();
                    let output = `Memory at $${addr} (16 bytes):\n\n`;
                    output += `$${addr}: `;
                    
                    for (let i = 0; i < bytes.length; i++) {
                        output += bytes[i].toString(16).padStart(2, '0').toUpperCase() + ' ';
                    }
                    
                    $('#debug2-display').text(output).show();
                }, (error) => {
                    $('#debug2-display').text(`Error: ${error}`).show();
                });
            }
        };
        
        // ============================================================================
        // DEBUG VIEWER 3: Write Test with Confirmation
        // ============================================================================
        
        var DebugViewer3 = {
            hasUnsavedChanges: false,
            
            initialize: function() {
                console.log('DebugViewer3: initialize()');
                $('#debug3-write').click(() => this.writeValue());
                $('#debug3-post-write').click(() => this.writeMultipleBytes());
            },
            
            activate: function() {
                console.log('DebugViewer3: activate()');
            },
            
            canDeactivate: function() {
                console.log(`DebugViewer3: canDeactivate() -> hasUnsavedChanges=${this.hasUnsavedChanges}`);
                if (this.hasUnsavedChanges) {
                    const confirmed = confirm('You have written data. Are you sure you want to leave this tab?');
                    if (confirmed) {
                        this.hasUnsavedChanges = false;
                        return true;
                    }
                    return false;
                }
                return true;
            },
            
            deactivate: function() {
                console.log('DebugViewer3: deactivate()');
            },
            
            refresh: function() {
                console.log('DebugViewer3: refresh() - not implemented for this viewer');
            },
            
            writeValue: function() {
                const addressStr = $('#debug3-address').val().replace(/[^0-9A-Fa-f]/g, '');
                const address = parseInt(addressStr, 16);
                
                const valueStr = $('#debug3-value').val().replace(/[^0-9A-Fa-f]/g, '');
                const value = parseInt(valueStr, 16);
                
                if (isNaN(address) || address < 0 || address > 0xFFFF) {
                    showError('Invalid address. Enter hex value (0000-FFFF)');
                    return;
                }
                
                if (isNaN(value) || value < 0 || value > 0xFF) {
                    showError('Invalid value. Enter hex byte (00-FF)');
                    return;
                }
                
                writeMemory(address, [value], () => {
                    const addr = address.toString(16).padStart(4, '0').toUpperCase();
                    const val = value.toString(16).padStart(2, '0').toUpperCase();
                    $('#debug3-status').html(`<span style="color: var(--success);">✓ Successfully wrote $${val} to address $${addr}</span>`);
                    this.hasUnsavedChanges = true;
                }, (error) => {
                    $('#debug3-status').html(`<span style="color: var(--danger);">✗ Write failed: ${error}</span>`);
                });
            },
            
            writeMultipleBytes: function() {
                const addressStr = $('#debug3-post-address').val().replace(/[^0-9A-Fa-f]/g, '');
                const address = parseInt(addressStr, 16);
                
                const valueStr = $('#debug3-post-value').val().replace(/[^0-9A-Fa-f]/g, '');
                const value = parseInt(valueStr, 16);
                
                const countStr = $('#debug3-post-count').val().replace(/[^0-9]/g, '');
                const count = parseInt(countStr, 10);
                
                if (isNaN(address) || address < 0 || address > 0xFFFF) {
                    showError('Invalid address. Enter hex value (0000-FFFF)');
                    return;
                }
                
                if (isNaN(value) || value < 0 || value > 0xFF) {
                    showError('Invalid value. Enter hex byte (00-FF)');
                    return;
                }
                
                if (isNaN(count) || count < 1 || count > 65536) {
                    showError('Invalid count. Enter value (1-65536)');
                    return;
                }
                
                // Create array filled with the value
                const dataArray = new Array(count).fill(value);
                
                writeMemory(address, dataArray, () => {
                    const addr = address.toString(16).padStart(4, '0').toUpperCase();
                    const val = value.toString(16).padStart(2, '0').toUpperCase();
                    const method = count > 128 ? 'POST' : 'PUT';
                    $('#debug3-post-status').html(`<span style="color: var(--success);">✓ Successfully wrote ${count} bytes of $${val} to $${addr} (${method} method)</span>`);
                    this.hasUnsavedChanges = true;
                }, (error) => {
                    $('#debug3-post-status').html(`<span style="color: var(--danger);">✗ Write failed: ${error}</span>`);
                });
            }
        };
        
        // ============================================================================
        // DEBUG VIEWER 4: 6502 Disassembler
        // ============================================================================
        
        var DisassemblerViewer = {
            initialize: function() {
                console.log('DisassemblerViewer: initialize()');
                $('#disasm-read').click(() => this.disassembleRaw());
                $('#disasm-read-formatted').click(() => this.disassembleFormatted());
            },
            
            activate: function() {
                console.log('DisassemblerViewer: activate()');
            },
            
            canDeactivate: function() {
                console.log('DisassemblerViewer: canDeactivate() -> true');
                return true;
            },
            
            deactivate: function() {
                console.log('DisassemblerViewer: deactivate()');
            },
            
            refresh: function() {
                console.log('DisassemblerViewer: refresh() - calling disassembleFormatted()');
                this.disassembleFormatted();
            },
            
            disassembleRaw: function() {
                console.log('DisassemblerViewer: disassembleRaw()');
                const addressStr = $('#disasm-address').val().replace(/[^0-9A-Fa-f]/g, '');
                const address = parseInt(addressStr, 16);
                
                const lengthStr = $('#disasm-length').val().replace(/[^0-9]/g, '');
                const length = parseInt(lengthStr, 10);
                
                if (isNaN(address) || address < 0 || address > 0xFFFF) {
                    showError('Invalid address. Enter hex value (0000-FFFF)');
                    return;
                }
                
                if (isNaN(length) || length < 1 || length > 4096) {
                    showError('Invalid length. Enter value (1-4096)');
                    return;
                }
                
                // Check if library is loaded
                if (typeof window.reasm6502 === 'undefined' || !window.reasm6502.disasm) {
                    showError('6502-reasm library not loaded');
                    return;
                }
                
                readMemory(address, length, (data) => {
                    try {
                        const bytes = Array.from(new Uint8Array(data));
                        
                        // Disassemble using 6502-reasm library
                        const disasmResult = window.reasm6502.disasm(bytes, address);
                        
                        const addr = address.toString(16).padStart(4, '0').toUpperCase();
                        let output = `Disassembly from $${addr} (${length} bytes, ${disasmResult.length} instructions):\n\n`;
                        output += JSON.stringify(disasmResult, null, 2);
                        
                        $('#disasm-display').text(output).show();
                        $('#disasm-display-formatted').hide();
                    } catch (error) {
                        $('#disasm-display').text(`Disassembly error: ${error.message}`).show();
                        $('#disasm-display-formatted').hide();
                    }
                }, (error) => {
                    $('#disasm-display').text(`Error reading memory: ${error}`).show();
                    $('#disasm-display-formatted').hide();
                });
            },
            
            disassembleFormatted: function() {
                console.log('DisassemblerViewer: disassembleFormatted()');
                const addressStr = $('#disasm-address').val().replace(/[^0-9A-Fa-f]/g, '');
                const address = parseInt(addressStr, 16);
                
                const lengthStr = $('#disasm-length').val().replace(/[^0-9]/g, '');
                const length = parseInt(lengthStr, 10);
                
                if (isNaN(address) || address < 0 || address > 0xFFFF) {
                    showError('Invalid address. Enter hex value (0000-FFFF)');
                    return;
                }
                
                if (isNaN(length) || length < 1 || length > 4096) {
                    showError('Invalid length. Enter value (1-4096)');
                    return;
                }
                
                // Check if library is loaded
                if (typeof window.reasm6502 === 'undefined' || !window.reasm6502.disasm) {
                    showError('6502-reasm library not loaded');
                    return;
                }
                
                readMemory(address, length, (data) => {
                    try {
                        const bytes = Array.from(new Uint8Array(data));
                        
                        // Disassemble using 6502-reasm library
                        const disasmResult = window.reasm6502.disasm(bytes, address);
                        const formatted = window.reasm6502.formatDisasm(disasmResult);
                        
                        const addr = address.toString(16).padStart(4, '0').toUpperCase();
                        let output = `Disassembly from $${addr} (${length} bytes, ${disasmResult.length} instructions):\n\n`;
                        output += formatted;
                        
                        $('#disasm-display').hide();
                        $('#disasm-display-formatted').text(output).show();
                    } catch (error) {
                        $('#disasm-display').hide();
                        $('#disasm-display-formatted').text(`Disassembly error: ${error.message}`).show();
                    }
                }, (error) => {
                    $('#disasm-display').hide();
                    $('#disasm-display-formatted').text(`Error reading memory: ${error}`).show();
                });
            }
        };
        
        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        // Wrap initialization in a function called by the script loader
        window.initializeApp = function() {
            console.log('=== API Debug Tool Initializing ===');
            
            // Initialize all viewers
            initializeViewers(['DebugViewer1', 'DebugViewer2', 'DebugViewer3', 'DisassemblerViewer']);
            
            // Set up tab system
            setupTabs(viewerMap, 'tab1');
            
            // Activate first tab
            DebugViewer1.activate();
            
            // Set up Refresh button
            $('#refreshBtn').click(function() {
                const activeViewer = getActiveViewer();
                if (activeViewer && activeViewer.refresh) {
                    activeViewer.refresh();
                }
            });
            
            // Handle page unload - check for unsaved changes
            window.addEventListener('beforeunload', function(e) {
                const activeViewer = getActiveViewer();
                if (activeViewer && activeViewer.canDeactivate && !activeViewer.canDeactivate()) {
                    e.preventDefault();
                    e.returnValue = '';
                    return '';
                }
            });
            
            console.log('=== Initialization Complete ===');
        };
    </script>
</body>
</html>
