<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Memory Browser Tool</title>
    <link id="app-favicon" rel="icon" href="data:,">

    <!-- Local requests section ---->
    <!-- --------------------------->

    <script>
    // Fonts: objects (url + font metadata)
    var requiredFonts = [
      {
        url: "fonts/C64ProMono.woff2",
        family: "C64ProMono",
        weight: "normal",
        style: "normal",
        display: "swap",
        format: "woff2"
      }
    ];

    // CSS: objects with url
    var requiredCSS = [
      { url: "css/mem-tools.css" }
    ];

    // JS: objects with url
    var requiredJS = [
      { url: "js/ui-components.js" },
      { url: "js/api-client.js" },
      { url: "js/tab-lifecycle.js" },
      { url: "js/hex-editor.js" }
    ];

    // UI selectors to disable during load
    var contentItems = [
      ".tab-content",
      ".tab-bar"
    ];
    </script>

    <!-- External requests section ---->
    <!-- ------------------------------>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- CommonJS shim for 6502-reasm library -->
    <script>
        var module = { exports: {} };
    </script>

    <!-- Load 6502-reasm library from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/6502-reasm@1.0.0/6502.min.js"></script>

    <!-- Make library globally accessible -->
    <script>
        window.reasm6502 = module.exports;
    </script>

    <!-- Inline CSS Syles section ---->
    <!-- ----------------------------->

    <style>
    /* common-inline.css - Shared styles for C64U Web Control Panel */

    :root {
        /* Colors */
        --primary: #3498db;
        --success: #2ecc71;
        --danger: #e74c3c;
        --warning: #ff9800;
        --bg: #1a1c1e;
        --card-bg: #25282c;
        --text: #e0e0e0;
        --text-dim: #a0a0a0;
        --border: #3a3f44;
        --input-bg: #2d3136;

        /* Spacing */
        --spacing-xs: 5px;
        --spacing-sm: 10px;
        --spacing-md: 20px;
        --spacing-lg: 30px;

        /* Border Radius */
        --radius-sm: 4px;
        --radius-md: 8px;

        /* Transitions */
        --transition: all 0.2s ease;
    }

    /* Base Styles */
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg);
        margin: 0;
        padding: var(--spacing-md);
        color: var(--text);
    }

    .container {
        max-width: 1000px;
        margin: 0 auto;
    }

    /* Header Components */
    header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
        border-bottom: 2px solid var(--primary);
        padding-bottom: var(--spacing-sm);
    }

    h1 {
        margin: 0;
        font-size: 24px;
        color: var(--primary);
    }

    .back-link {
        font-size: 12px;
        color: var(--text-dim);
        text-decoration: none;
        margin-top: var(--spacing-xs);
        display: inline-block;
    }

    .back-link:hover {
        color: var(--primary);
    }

    .header-actions {
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
    }

    /* Authentication Box */
    .auth-box {
        /* No background or border - just contains the password input */
    }

    .auth-password-input {
        width: 120px;
        border: none;
        background: transparent;
        padding: 0;
        color: var(--text);
        font-family: monospace;
    }

    /* Loading Spinner */
    .spinner {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 4px solid var(--text-dim);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Error/Success Messages */
    .error-box {
        display: none;
        background: var(--danger);
        color: white;
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        margin-bottom: 15px;
        font-weight: bold;
    }

    .success-message {
        color: var(--success);
    }

    .error-message {
        color: var(--danger);
    }

    /* Tab Components */
    .tab-bar {
        display: flex;
        gap: var(--spacing-xs);
        margin-bottom: var(--spacing-md);
        border-bottom: 2px solid var(--border);
    }

    .tab-button {
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--input-bg);
        color: var(--text-dim);
        border: none;
        border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        cursor: pointer;
        font-weight: bold;
        border: 1px solid var(--border);
        border-bottom: none;
        transition: var(--transition);
    }

    .tab-button:hover {
        background: var(--card-bg);
        color: var(--text);
    }

    .tab-button.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .tab-content {
        background: var(--card-bg);
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
        padding: var(--spacing-md);
        min-height: 400px;
    }

    .tab-content.content-hidden {
        visibility: hidden;
    }

    /* Form Controls */
    input[type="text"],
    input[type="password"],
    select {
        padding: 8px;
        background: var(--input-bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--text);
        font-family: monospace;
    }

    select {
        cursor: pointer;
    }

    input:focus,
    select:focus {
        outline: none;
        border-color: var(--primary);
    }

    label {
        color: var(--text-dim);
        font-weight: bold;
    }

    /* Buttons */
    button {
        padding: 8px 16px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-weight: bold;
        transition: var(--transition);
    }

    button:hover {
        opacity: 0.8;
    }

    .btn-primary { background: var(--primary); }
    .btn-success { background: var(--success); }
    .btn-danger { background: var(--danger); }
    .btn-warning { background: var(--warning); }

    /* Control Groups */
    .control-group {
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
        margin-bottom: 15px;
    }

    .control-group label {
        color: var(--text-dim);
        font-weight: bold;
    }

    .control-group input {
        width: 100px;
    }

    /* Info/Status Boxes */
    .info-box {
        background: rgba(255, 255, 255, 0.05);
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        margin-bottom: 15px;
        font-size: 12px;
        color: var(--text-dim);
    }

    /* Console/Code Display */
    .console-display {
        background: #121416;
        color: #7fdbff;
        padding: 15px;
        border-radius: var(--radius-sm);
        font-family: monospace;
        font-size: 13px;
        white-space: pre;
        overflow-x: auto;
        margin-top: 15px;
        border: 1px solid #333;
    }

    .code-display {
        background: var(--input-bg);
        color: var(--text);
        padding: 15px;
        border-radius: var(--radius-sm);
        font-family: monospace;
        font-size: 13px;
        white-space: pre;
        overflow-x: auto;
        border: 1px solid var(--border);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        body {
            padding: var(--spacing-sm);
        }

        header {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--spacing-sm);
        }

        .header-actions {
            width: 100%;
            justify-content: space-between;
        }

        .tab-bar {
            flex-wrap: wrap;
        }

        .control-group {
            flex-wrap: wrap;
        }
    }

    /* Content Disabled State - Used during script loading */
    .content-disabled {
        filter: grayscale(100%) brightness(0.8);
        opacity: 0.6;
        pointer-events: none;
    }

    /* Input Disabled State */
    .input-disabled {
        opacity: 0.4;
        pointer-events: none;
    }

    /* Modal Dialog Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-dialog {
        background: var(--card-bg);
        border: 2px solid var(--border);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        min-width: 400px;
        max-width: 600px;
    }

    .modal-instructions {
        color: var(--text-dim);
        font-size: 14px;
        margin-bottom: var(--spacing-sm);
    }

    .modal-textarea {
        width: 100%;
        height: 100px;
        background: var(--input-bg);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 8px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        resize: vertical;
        margin-bottom: var(--spacing-md);
        box-sizing: border-box;
    }

    .modal-textarea:focus {
        outline: none;
        border-color: var(--primary);
    }

    .modal-buttons {
        display: flex;
        gap: var(--spacing-sm);
        justify-content: flex-end;
    }
    </style>

    <!-- Inline JS Scripts section ---->
    <!-- ------------------------------>

    <script>
    /* common-inline.js
     * No Concurrent File Load (sequential): CSS -> Fonts -> JS -> Favicon
     *
     * Per-page globals (define BEFORE this runs):
     *   var requiredFonts = [{ url, family, weight, style, display?, format? }, ...];
     *   var requiredCSS   = [{ url }, ...];
     *   var requiredJS    = [{ url }, ...];
     *   var contentItems  = ['.selector', ...];
     *
     * Optional:
     *   window.initializeApp()
     */

    (function () {
      'use strict';

      // ----------------------------
      // Defaults (if page forgets)
      // ----------------------------
      if (!Array.isArray(window.requiredFonts)) window.requiredFonts = [];
      if (!Array.isArray(window.requiredCSS)) window.requiredCSS = [];
      if (!Array.isArray(window.requiredJS)) window.requiredJS = [];
      if (!Array.isArray(window.contentItems)) window.contentItems = [];

      // ----------------------------
      // UI helpers
      // ----------------------------
      function showSpinner() {
        var spinner = document.getElementById('spinner');
        if (spinner) spinner.style.display = 'inline-block';
      }

      function hideSpinner() {
        var spinner = document.getElementById('spinner');
        if (spinner) spinner.style.display = 'none';
      }

      function disableContent() {
        window.contentItems.forEach(function (selector) {
          var el = document.querySelector(selector);
          if (el) el.classList.add('content-disabled');
        });
      }

      function enableContent() {
        window.contentItems.forEach(function (selector) {
          var el = document.querySelector(selector);
          if (el) {
            el.classList.remove('content-disabled');
            el.classList.remove('content-hidden');
            }
        });
      }

      function showCriticalError(message, fileUrl) {
        hideSpinner(); // keep content disabled

        var text = '❌ ' + message + (fileUrl ? (' (' + fileUrl + ')') : '') + ' Please reload.';

        var host = document.querySelector('.header-actions') || document.body;

        var existing = document.getElementById('critical-error-inline');
        if (existing) {
          existing.textContent = text;
          return;
        }

        var span = document.createElement('span');
        span.id = 'critical-error-inline';
        span.textContent = text;
        span.style.cssText =
          'color:#e74c3c;font-weight:bold;font-size:14px;margin-right:25px;';

        if (host.firstChild) host.insertBefore(span, host.firstChild);
        else host.appendChild(span);
      }

      // Optional exports
      window.showSpinner = showSpinner;
      window.hideSpinner = hideSpinner;
      window.disableContent = disableContent;
      window.enableContent = enableContent;
      window.showCriticalError = showCriticalError;

      // ----------------------------
      // Favicon stage (best-effort, last)
      // ----------------------------

      function ensurePlaceholderFaviconLink() {
        var link = document.getElementById('app-favicon');
        if (!link) {
          link = document.createElement('link');
          link.id = 'app-favicon';
          link.rel = 'icon';
          document.head.appendChild(link);
        }
        if (!link.href) link.href = 'data:,';
        return link;
      }

      function setFaviconHref(url) {
        var link = ensurePlaceholderFaviconLink();
        link.href = url;
      }

      // Best-effort: if favicon.ico exists next to the HTML file, set it.
      // Do nothing on any failure.
      function tryLoadFaviconLast() {
        ensurePlaceholderFaviconLink();

        var url = 'favicon.ico';

        // Use HEAD probe to avoid downloading it; fallback to GET if HEAD fails.
        return fetch(url, { method: 'HEAD', cache: 'no-store' })
          .then(function (r) {
            if (r && r.ok) setFaviconHref(url);
          })
          .catch(function () {
            return fetch(url, { method: 'GET', cache: 'no-store' })
              .then(function (r) {
                if (r && r.ok) setFaviconHref(url);
              })
              .catch(function () { /* ignore */ });
          });
      }

      // ----------------------------
      // Sequential loaders
      // ----------------------------

      function loadCSSSequential(list) {
        if (!list.length) return Promise.resolve();

        var i = 0;

        function next() {
          if (i >= list.length) return Promise.resolve();

          var item = list[i++];
          var url = item && item.url;

          if (!url) {
            return Promise.reject({ stage: 'css', url: null, error: new Error('Invalid CSS spec') });
          }

          return new Promise(function (resolve, reject) {
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = url;

            link.onload = function () { resolve(); };
            link.onerror = function () { reject(new Error('CSS load error')); };

            document.head.appendChild(link);
          }).then(next).catch(function (e) {
            return Promise.reject({ stage: 'css', url: url, error: e });
          });
        }

        return next();
      }

      function loadFontsSequential(list) {
        if (!list.length) return Promise.resolve();

        if (!('FontFace' in window) || !document.fonts) {
          // Non-fatal: allow fallback fonts
          return Promise.resolve();
        }

        var i = 0;

        function next() {
          if (i >= list.length) return Promise.resolve();

          var f = list[i++];
          if (!f || !f.url || !f.family) {
            return Promise.reject({ stage: 'font', url: (f && f.url) || null, error: new Error('Invalid font spec') });
          }

          var descriptors = {
            weight: f.weight || 'normal',
            style: f.style || 'normal'
          };
          if (f.display) descriptors.display = f.display;

          var face = new FontFace(
            f.family,
            "url('" + f.url + "')" + (f.format ? (" format('" + f.format + "')") : ''),
            descriptors
          );

          return face.load().then(function (loaded) {
            document.fonts.add(loaded);
            return next();
          }).catch(function (e) {
            return Promise.reject({ stage: 'font', url: f.url, error: e });
          });
        }

        return next();
      }

      function loadJSSequential(list) {
        if (!list.length) return Promise.resolve();

        var i = 0;

        function next() {
          if (i >= list.length) return Promise.resolve();

          var item = list[i++];
          var url = item && item.url;

          if (!url) {
            return Promise.reject({ stage: 'js', url: null, error: new Error('Invalid JS spec') });
          }

          return new Promise(function (resolve, reject) {
            var script = document.createElement('script');
            script.src = url;

            var hadErrorForThisScript = false;

            function onWindowError(event) {
              if (event && event.filename && event.filename.indexOf(url) !== -1) {
                hadErrorForThisScript = true;
              }
            }

            window.addEventListener('error', onWindowError);

            script.onload = function () {
              setTimeout(function () {
                window.removeEventListener('error', onWindowError);
                if (hadErrorForThisScript) reject(new Error('JS syntax/runtime error'));
                else resolve();
              }, 50);
            };

            script.onerror = function () {
              window.removeEventListener('error', onWindowError);
              reject(new Error('JS network error'));
            };

            document.head.appendChild(script);
          }).then(next).catch(function (e) {
            return Promise.reject({ stage: 'js', url: url, error: e });
          });
        }

        return next();
      }

      // ----------------------------
      // Orchestrator + boot
      // ----------------------------

      function loadAllSequentially() {
        // Favicon is last and best-effort: never fails the pipeline.
        return loadCSSSequential(window.requiredCSS)
          .then(function () { return loadFontsSequential(window.requiredFonts); })
          .then(function () { return loadJSSequential(window.requiredJS); })
          .then(function () { return tryLoadFaviconLast().catch(function () { /* ignore */ }); });
      }

      function startPageLoad() {
        showSpinner();
        disableContent();

        loadAllSequentially()
          .then(function () {
            hideSpinner();
            enableContent();

            if (typeof window.initializeApp === 'function') {
              window.initializeApp();
            }
          })
          .catch(function (info) {
            var stage = (info && info.stage) ? info.stage : 'unknown';
            var url = (info && info.url) ? info.url : null;

            showCriticalError('Failed to load local ' + stage + ' resource.', url);
            console.error('Critical load failure:', info);
          });
      }

      if (window.jQuery && typeof window.jQuery === 'function') {
        jQuery(document).ready(function () {
          setTimeout(startPageLoad, 25);
        });
      } else {
        document.addEventListener('DOMContentLoaded', function () {
          setTimeout(startPageLoad, 25);
        });
      }
    })();
    </script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div>
                <h1>Ultimate Memory Browser Tool</h1>
                <a href="/" class="back-link">← Back to Control Panel</a>
            </div>
            <div class="header-actions">
                <span id="spinner" class="spinner" style="display:none;"></span>
                <button id="refreshBtn" class="btn-success">Refresh</button>
                <div class="auth-box">
                    <form autocomplete="on">
                        <input type="text" name="username" value="ultimate-api" autocomplete="username" style="display: none;">
                        <input type="password" id="apiPassword" name="password" placeholder="API Password" autocomplete="current-password" class="auth-password-input">
                    </form>
                </div>
            </div>
        </header>

        <!-- Error Box -->
        <div id="errorBox" class="error-box"></div>

        <!-- Tab Bar -->
        <div class="tab-bar content-disabled">
            <button class="tab-button active" data-tab="tab0">Hex Viewer</button>
            <button class="tab-button" data-tab="tab1">Disassembly</button>
            <button class="tab-button" data-tab="tab2">Debug Viewer 1</button>
            <button class="tab-button" data-tab="tab3">Debug Viewer 2</button>
            <button class="tab-button" data-tab="tab4">Debug Viewer 3</button>
        </div>

        <!-- Hex Viewer: Memory Browser -->
        <div id="tab0-content" class="tab-content content-hidden">
            <!-- Hex Viewer Header -->
            <div class="mem-header">
                <div class="mem-header-left">
                    <label>Address:</label>
                    <input type="text" id="hex-address" value="0400" placeholder="0400" class="mem-input-address">

                    <label>Page Size:</label>
                    <select id="hex-pagesize" class="mem-select">
                        <option value="128">128</option>
                        <option value="256" selected>256</option>
                        <option value="512">512</option>
                        <option value="1024">1024</option>
                    </select>

                    <label>Charset:</label>
                    <select id="hex-charset" class="mem-select">
                        <option value="0xEE00" selected>Screen 1</option>
                        <option value="0xEF00">Screen 2</option>
                        <option value="0xE000">PETSCII 1</option>
                        <option value="0xE100">PETSCII 2</option>
                    </select>
                </div>

                <div class="mem-header-right">
                    <button class="mem-nav-btn" id="mem-nav-up" title="Up">▲</button>
                    <button class="mem-nav-btn" id="mem-nav-down" title="Down">▼</button>
                    <button class="mem-nav-btn" id="mem-nav-left" title="Left">◄</button>
                    <button class="mem-nav-btn" id="mem-nav-right" title="Right">►</button>
                    <button class="mem-nav-btn mem-nav-page" id="hex-prev-page">Prev Page</button>
                    <button class="mem-nav-btn mem-nav-page" id="hex-next-page">Next Page</button>
                </div>
            </div>

            <!-- Hex Viewer Sub-header -->
            <div class="mem-subheader">
                <div class="mem-subheader-left">
                    <span id="hex-current-address">$0400 (1024) - $04FF (1279)</span>
                </div>
                <div class="mem-subheader-right">
                    <button class="btn-primary" id="hex-edit-btn" style="display:inline-block;">Edit</button>
                    <button class="btn-success" id="hex-save-btn" style="display:none;">Save</button>
                    <button class="btn-danger" id="hex-cancel-btn" style="display:none;">Cancel</button>
                </div>
            </div>

            <!-- Hex Viewer Memory Display -->
            <div class="hex-display" id="hex-display">
                <!-- Placeholder data will be generated here -->
            </div>
        </div>

        <!-- Disassembly Viewer: 6502 Assembly Browser -->
        <div id="tab1-content" class="tab-content" style="display:none;">
            <!-- Disassembly Viewer Header -->
            <div class="mem-header">
                <div class="mem-header-left">
                    <label>Address:</label>
                    <input type="text" id="disasm-address" value="C000" placeholder="C000" class="mem-input-address">

                    <label>Length:</label>
                    <select id="disasm-length" class="mem-select">
                        <option value="32">32</option>
                        <option value="64" selected>64</option>
                        <option value="128">128</option>
                    </select>
                </div>

                <div class="mem-header-right">
                    <button class="mem-nav-btn" id="disasm-nav-up" title="Up">▲</button>
                    <button class="mem-nav-btn" id="disasm-nav-down" title="Down">▼</button>
                    <button class="mem-nav-btn mem-nav-page" id="disasm-prev-page">Prev Page</button>
                    <button class="mem-nav-btn mem-nav-page" id="disasm-next-page">Next Page</button>
                </div>
            </div>

            <!-- Disassembly Viewer Sub-header -->
            <div class="mem-subheader">
                <div class="mem-subheader-left">
                    <span id="disasm-current-address">$C000 (49152) - $C03F (49215)</span>
                </div>
            </div>

            <!-- Disassembly Viewer Memory Display -->
            <div class="disasm-display" id="disasm-display">
                <!-- Disassembly data will be generated here -->
            </div>
        </div>

        <!-- Debug Viewer 1: Simple Read Test -->
        <div id="tab2-content" class="tab-content" style="display:none;">
            <div class="info-box">
                <strong>Debug Viewer 1</strong><br>
                Tests basic memory reading. Reads 256 bytes from address $0400 (screen memory start).
            </div>
            <button id="debug1-read" class="btn-primary">Test Read Memory ($0400, 256 bytes)</button>
            <div id="debug1-display" class="console-display" style="display:none;"></div>
        </div>

        <!-- Debug Viewer 2: Parameterized Read -->
        <div id="tab3-content" class="tab-content" style="display:none;">
            <div class="info-box">
                <strong>Debug Viewer 2</strong><br>
                Tests parameterized reading. Enter any address and read 16 bytes.
            </div>
            <div class="control-group">
                <label>Address:</label>
                <input type="text" id="debug2-address" value="C000" placeholder="C000">
                <button id="debug2-read" class="btn-primary">Read 16 Bytes</button>
            </div>
            <div id="debug2-display" class="console-display" style="display:none;"></div>
        </div>

        <!-- Debug Viewer 3: Write Test with Confirmation -->
        <div id="tab4-content" class="tab-content" style="display:none;">
            <div class="info-box">
                <strong>Debug Viewer 3</strong><br>
                Tests memory writing and canDeactivate() protocol. Write a byte and try switching tabs - you'll be prompted to confirm.
            </div>
            <div class="control-group">
                <label>Address:</label>
                <input type="text" id="debug3-address" value="0400" placeholder="0400">
                <label>Value:</label>
                <input type="text" id="debug3-value" value="41" placeholder="41" style="width: 60px;">
                <button id="debug3-write" class="btn-primary">Write Byte</button>
            </div>
            <div id="debug3-status" style="margin-top: 15px; color: var(--text-dim);"></div>

            <div class="control-group" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                <div style="margin-bottom: 10px; color: var(--text-dim); font-size: 13px;">
                    <strong>POST Write Test (>128 bytes)</strong><br>
                    Tests POST method by writing multiple bytes.
                </div>
                <label>Address:</label>
                <input type="text" id="debug3-post-address" value="D800" placeholder="D800">
                <label>Value:</label>
                <input type="text" id="debug3-post-value" value="00" placeholder="00" style="width: 60px;">
                <label>Count:</label>
                <input type="text" id="debug3-post-count" value="200" placeholder="200" style="width: 60px;">
                <button id="debug3-post-write" class="btn-primary">Write Bytes</button>
            </div>
            <div id="debug3-post-status" style="margin-top: 15px; color: var(--text-dim);"></div>
        </div>
    </div>

    <script>
        // ============================================================================
        // SHARED LIBRARIES (ui-components.js, api-client.js, tab-lifecycle.js)
        // ============================================================================
        // All common API methods and UI functions are now in shared libraries

        // ============================================================================
        // TAB MANAGEMENT (using tab-lifecycle.js)
        // ============================================================================

        const tabMap = {
            'tab0': 'HexViewer',
            'tab1': 'DisassemblyViewer',
            'tab2': 'DebugViewer1',
            'tab3': 'DebugViewer2',
            'tab4': 'DebugViewer3'
        };

        // ============================================================================
        // HEX VIEWER: Memory Browser (using hex-editor.js)
        // ============================================================================

        var HexViewer = {
            initialize: function() {
                console.log('HexViewer: initialize()');

                // Initialize hex editor with empty data first
                const initialAddress = parseInt($('#hex-address').val(), 16) || 0x0400;
                const initialPageSize = parseInt($('#hex-pagesize').val()) || 256;
                const emptyData = new Uint8Array(initialPageSize);
                hexEditorInit($('#hex-display'), initialAddress, emptyData);

                // Set up mouse handlers
                hexEditorSetupMouse();

                // Set up browsing mode keyboard navigation
                hexEditorSetupBrowsingKeys();

                // Set navigation callback for keyboard navigation
                hexEditorSetNavigationCallback(() => this.updateAddressDisplay());

                // Set up navigation controls
                this.setupNavigation();

                // Set up Edit/Save/Cancel buttons
                const enterEditMode = () => {
                    // Don't enter edit mode if API is busy
                    if (isApiBusy()) {
                        return;
                    }
                    hexEditorEnterEditMode();
                    $('#hex-edit-btn').hide();
                    $('#hex-save-btn, #hex-cancel-btn').show();
                    this.updateAddressDisplay();
                };

                const saveChanges = () => {
                    // Save changes using hex-editor.js function
                    hexEditorSaveChanges(
                        () => {
                            // Success: exit edit mode and reload memory
                            hexEditorExitEditMode(true);
                            $('#hex-save-btn, #hex-cancel-btn').hide();
                            $('#hex-edit-btn').show();

                            // Reload memory to show saved state
                            const currentAddress = hexEditorState.startAddress;
                            hexEditorNavigateToAddress(currentAddress, () => {
                                this.updateAddressDisplay();
                            });
                        },
                        (errorMsg) => {
                            // Error: stay in edit mode (error already displayed)
                            console.error('Save failed:', errorMsg);
                        }
                    );
                };

                $('#hex-edit-btn').click(enterEditMode);
                $('#hex-save-btn').click(saveChanges);

                // Set keyboard shortcut callbacks
                hexEditorSetEnterEditModeCallback(enterEditMode);
                hexEditorSetSaveCallback(saveChanges);

                $('#hex-cancel-btn').click(() => {
                    // Check if there are unsaved changes
                    if (hexEditorIsModified()) {
                        if (!confirm('Discard all changes?')) {
                            return; // User canceled, stay in edit mode
                        }
                    }

                    hexEditorExitEditMode(false); // save = false (cancel)
                    $('#hex-save-btn, #hex-cancel-btn').hide();
                    $('#hex-edit-btn').show();
                    this.updateAddressDisplay();
                });
            },

            setupNavigation: function() {
                // Address input - navigate on Enter
                $('#hex-address').on('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();

                        // Don't navigate if API is busy
                        if (isApiBusy()) {
                            return;
                        }

                        let addressStr = $('#hex-address').val().trim();

                        // Remove invalid hex characters (keep only 0-9, A-F, a-f)
                        addressStr = addressStr.replace(/[^0-9A-Fa-f]/g, '');

                        // Parse address
                        let address = parseInt(addressStr, 16);

                        // Validate address
                        if (isNaN(address) || address < 0 || address > 0xFFFF) {
                            alert('Invalid address. Please enter a hex value between 0000 and FFFF.');
                            return;
                        }

                        // Validate and fix address using centralized function
                        address = hexEditorValidateAddress(address);

                        // Normalize to uppercase 4-digit hex
                        const normalizedStr = address.toString(16).toUpperCase().padStart(4, '0');

                        // Update input field with normalized address
                        $('#hex-address').val(normalizedStr);

                        // Remove focus to allow immediate navigation
                        $('#hex-address').blur();

                        hexEditorNavigateToAddress(address, () => {
                            this.updateAddressDisplay();
                        });
                    }
                });

                // Page size selector - reload data with new page size
                $('#hex-pagesize').on('change', () => {
                    const pageSize = parseInt($('#hex-pagesize').val());
                    hexEditorSetPageSize(pageSize);

                    // Validate current address with new page size
                    const currentAddress = hexEditorValidateAddress(hexEditorState.startAddress, pageSize);

                    // Reload data at (possibly adjusted) address with new page size
                    hexEditorNavigateToAddress(currentAddress, () => {
                        this.updateAddressDisplay();
                    });
                });

                // Charset selector - update character display
                $('#hex-charset').on('change', () => {
                    const puaBase = parseInt($('#hex-charset').val());
                    hexEditorSetCharsetPuaBase(puaBase);

                    // Re-render display to show new charset
                    hexEditorRender();
                });

                // Navigation buttons
                $('#mem-nav-up').click(() => {
                    if (isApiBusy()) return;
                    hexEditorNavigateUp(() => this.updateAddressDisplay());
                });

                $('#mem-nav-down').click(() => {
                    if (isApiBusy()) return;
                    hexEditorNavigateDown(() => this.updateAddressDisplay());
                });

                $('#mem-nav-left').click(() => {
                    if (isApiBusy()) return;
                    hexEditorNavigateLeft(() => this.updateAddressDisplay());
                });

                $('#mem-nav-right').click(() => {
                    if (isApiBusy()) return;
                    hexEditorNavigateRight(() => this.updateAddressDisplay());
                });

                $('#hex-prev-page').click(() => {
                    if (isApiBusy()) return;
                    hexEditorNavigatePrevPage(() => this.updateAddressDisplay());
                });

                $('#hex-next-page').click(() => {
                    if (isApiBusy()) return;
                    hexEditorNavigateNextPage(() => this.updateAddressDisplay());
                });
            },

            updateAddressDisplay: function() {
                const range = hexEditorGetAddressRange();
                const startHex = range.startAddress.toString(16).toUpperCase().padStart(4, '0');
                const endHex = range.endAddress.toString(16).toUpperCase().padStart(4, '0');

                // Update address input to match current address
                $('#hex-address').val(startHex);

                // Update address display
                $('#hex-current-address').text(
                    `$${startHex} (${range.startAddress}) - $${endHex} (${range.endAddress})`
                );
            },

            activate: function() {
                console.log('HexViewer: activate()');
                this.refresh();
            },

            canDeactivate: function() {
                console.log('HexViewer: canDeactivate()');
                // Check if in edit mode with unsaved changes
                if (hexEditorState.editMode && hexEditorIsModified()) {
                    return confirm('You have unsaved changes. Leave anyway?');
                }
                return true;
            },

            deactivate: function() {
                console.log('HexViewer: deactivate()');
            },

            refresh: function() {
                console.log('HexViewer: refresh()');
                // Don't refresh if API is busy
                if (isApiBusy()) {
                    return;
                }
                // Reload current memory address
                const currentAddress = hexEditorState.startAddress;
                hexEditorNavigateToAddress(currentAddress, () => {
                    this.updateAddressDisplay();
                });
            }
        };

        // ============================================================================
        // DISASSEMBLY VIEWER: 6502 Assembly Browser
        // ============================================================================

        var DisassemblyViewer = {
            currentAddress: 0xC000,
            currentLength: 64,

            initialize: function() {
                console.log('DisassemblyViewer: initialize()');

                // Address input
                $('#disasm-address').on('input', () => this.onAddressChange());
                $('#disasm-address').on('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.navigateToAddress();
                        $('#disasm-address').blur();
                    }
                });

                // Length selector
                $('#disasm-length').change(() => this.onLengthChange());

                // Navigation buttons
                $('#disasm-nav-up').click(() => this.navigateUp());
                $('#disasm-nav-down').click(() => this.navigateDown());
                $('#disasm-prev-page').click(() => this.navigatePrevPage());
                $('#disasm-next-page').click(() => this.navigateNextPage());

                // Keyboard shortcuts
                $(document).on('keydown', (e) => {
                    if (!this.isActive()) return;

                    // Ignore if typing in input field
                    if ($(e.target).is('input, textarea, select')) {
                        return;
                    }

                    switch(e.key.toLowerCase()) {
                        case 'r':
                            e.preventDefault();
                            this.refresh();
                            break;
                        case 'arrowup':
                            e.preventDefault();
                            this.navigateUp();
                            break;
                        case 'arrowdown':
                            e.preventDefault();
                            this.navigateDown();
                            break;
                        case 'pageup':
                            e.preventDefault();
                            this.navigatePrevPage();
                            break;
                        case 'pagedown':
                            e.preventDefault();
                            this.navigateNextPage();
                            break;
                        case 'a':
                            e.preventDefault();
                            $('#disasm-address').focus().select();
                            break;
                    }
                });
            },

            activate: function() {
                console.log('DisassemblyViewer: activate()');
                this.refresh();
            },

            canDeactivate: function() {
                console.log('DisassemblyViewer: canDeactivate() -> true');
                return true;
            },

            deactivate: function() {
                console.log('DisassemblyViewer: deactivate()');
            },

            isActive: function() {
                return $('#tab1-content').is(':visible');
            },

            refresh: function() {
                console.log('DisassemblyViewer: refresh()');
                this.loadMemoryAndDisassemble();
            },

            onAddressChange: function() {
                const addressStr = $('#disasm-address').val().replace(/[^0-9A-Fa-f]/g, '');
                const address = parseInt(addressStr, 16);

                if (!isNaN(address) && address >= 0 && address <= 0xFFFF) {
                    this.currentAddress = address;
                }
            },

            onLengthChange: function() {
                const length = parseInt($('#disasm-length').val(), 10);
                this.currentLength = length;
                this.clampAddress();
                this.updateAddressInput();
                this.loadMemoryAndDisassemble();
            },

            navigateToAddress: function() {
                this.onAddressChange();
                this.clampAddress();
                this.updateAddressInput();
                this.loadMemoryAndDisassemble();
            },

            navigateUp: function() {
                this.currentAddress = Math.max(0, this.currentAddress - 1);
                this.updateAddressInput();
                this.loadMemoryAndDisassemble();
            },

            navigateDown: function() {
                this.currentAddress = Math.min(0xFFFF, this.currentAddress + 1);
                this.clampAddress();
                this.updateAddressInput();
                this.loadMemoryAndDisassemble();
            },

            navigatePrevPage: function() {
                this.currentAddress = Math.max(0, this.currentAddress - this.currentLength);
                this.updateAddressInput();
                this.loadMemoryAndDisassemble();
            },

            navigateNextPage: function() {
                this.currentAddress = Math.min(0xFFFF, this.currentAddress + this.currentLength);
                this.clampAddress();
                this.updateAddressInput();
                this.loadMemoryAndDisassemble();
            },

            clampAddress: function() {
                // Ensure address + length doesn't exceed 0xFFFF
                if (this.currentAddress + this.currentLength > 0x10000) {
                    this.currentAddress = 0x10000 - this.currentLength;
                }
                this.currentAddress = Math.max(0, Math.min(0xFFFF, this.currentAddress));
            },

            updateAddressInput: function() {
                const addressStr = this.currentAddress.toString(16).padStart(4, '0').toUpperCase();
                $('#disasm-address').val(addressStr);
            },

            updateSubheader: function() {
                const startAddr = this.currentAddress;
                const endAddr = Math.min(0xFFFF, startAddr + this.currentLength - 1);

                const startHex = startAddr.toString(16).padStart(4, '0').toUpperCase();
                const endHex = endAddr.toString(16).padStart(4, '0').toUpperCase();

                $('#disasm-current-address').text(
                    `$${startHex} (${startAddr}) - $${endHex} (${endAddr})`
                );
            },

            loadMemoryAndDisassemble: function() {
                const address = this.currentAddress;
                const length = this.currentLength;

                this.updateSubheader();

                // Check if library is loaded
                if (typeof window.reasm6502 === 'undefined' || !window.reasm6502.disasm) {
                    showError('6502-reasm library not loaded');
                    return;
                }

                readMemory(address, length, (data) => {
                    try {
                        const bytes = Array.from(new Uint8Array(data));

                        // Disassemble using 6502-reasm library
                        const disasmResult = window.reasm6502.disasm(bytes, address);

                        this.renderDisassembly(disasmResult, bytes, address);
                    } catch (error) {
                        showError(`Disassembly error: ${error.message}`);
                    }
                }, (error) => {
                    showError(`Error reading memory: ${error}`);
                });
            },

            renderDisassembly: function(instructions, bytes, startAddress) {
                const $display = $('#disasm-display');
                $display.empty();

                let html = '';
                let byteOffset = 0;

                for (let i = 0; i < instructions.length; i++) {
                    const instr = instructions[i];
                    const addr = instr.address;
                    const addrHex = addr.toString(16).padStart(4, '0').toUpperCase();

                    // Column 1: Address
                    const col1 = `<span class="disasm-col-addr">$${addrHex}</span>`;

                    // Column 2: Hex bytes (1-3 bytes)
                    const instrBytes = instr.bytes || [];
                    let bytesHex = '';
                    for (let j = 0; j < instrBytes.length; j++) {
                        bytesHex += instrBytes[j].toString(16).padStart(2, '0').toUpperCase() + ' ';
                    }
                    bytesHex = bytesHex.padEnd(9, ' '); // Pad to 3 bytes width
                    const col2 = `<span class="disasm-col-bytes">${bytesHex}</span>`;

                    // Column 3: Assembly instruction
                    const assembly = instr.assembly || '???';
                    const col3 = `<span class="disasm-col-instr">${assembly}</span>`;

                    // Column 4: Jump/branch target
                    const col4 = this.getJumpTarget(instr, bytes, startAddress);

                    html += `<div class="disasm-row">${col1}${col2}${col3}${col4}</div>`;

                    byteOffset += instrBytes.length;
                }

                $display.html(html);
            },

            getJumpTarget: function(instr, bytes, startAddress) {
                const assembly = instr.assembly || '';
                const addr = instr.address;
                const instrBytes = instr.bytes || [];

                // Conditional branches (relative addressing)
                if (/^(BCC|BCS|BEQ|BMI|BNE|BPL|BVC|BVS)\s/.test(assembly)) {
                    if (instrBytes.length === 2) {
                        const offset = instrBytes[1];
                        const signedOffset = offset > 127 ? offset - 256 : offset;
                        const targetAddr = (addr + 2 + signedOffset) & 0xFFFF;
                        const targetHex = targetAddr.toString(16).padStart(4, '0').toUpperCase();
                        return `<span class="disasm-col-target">→ $${targetHex}</span>`;
                    }
                }

                // Unconditional jumps (absolute addressing)
                if (/^JMP\s\$[0-9A-F]{4}/.test(assembly)) {
                    if (instrBytes.length === 3) {
                        const targetAddr = instrBytes[1] | (instrBytes[2] << 8);
                        const targetHex = targetAddr.toString(16).padStart(4, '0').toUpperCase();
                        return `<span class="disasm-col-target">→ $${targetHex}</span>`;
                    }
                }

                // JSR (absolute addressing)
                if (/^JSR\s\$[0-9A-F]{4}/.test(assembly)) {
                    if (instrBytes.length === 3) {
                        const targetAddr = instrBytes[1] | (instrBytes[2] << 8);
                        const targetHex = targetAddr.toString(16).padStart(4, '0').toUpperCase();
                        return `<span class="disasm-col-target">→ $${targetHex}</span>`;
                    }
                }

                // Indirect jumps - peek memory to get actual target
                if (/^JMP\s\(\$[0-9A-F]{4}\)/.test(assembly)) {
                    if (instrBytes.length === 3) {
                        const indirectAddr = instrBytes[1] | (instrBytes[2] << 8);
                        const indirectHex = indirectAddr.toString(16).padStart(4, '0').toUpperCase();

                        // Try to peek the target address (asynchronously)
                        this.peekIndirectTarget(indirectAddr, (targetAddr) => {
                            if (targetAddr !== null) {
                                const targetHex = targetAddr.toString(16).padStart(4, '0').toUpperCase();
                                return `<span class="disasm-col-target">→ ($${indirectHex}) $${targetHex}</span>`;
                            }
                        });

                        return `<span class="disasm-col-target">→ ($${indirectHex})</span>`;
                    }
                }

                return '<span class="disasm-col-target"></span>';
            },

            peekIndirectTarget: function(indirectAddr, callback) {
                // Read 2 bytes from indirect address to get actual target
                readMemory(indirectAddr, 2, (data) => {
                    const bytes = new Uint8Array(data);
                    const targetAddr = bytes[0] | (bytes[1] << 8);
                    callback(targetAddr);
                }, (error) => {
                    callback(null);
                });
            }
        };
        // ============================================================================
        // DEBUG VIEWER 1: Simple Read Test
        // ============================================================================

        var DebugViewer1 = {
            initialize: function() {
                console.log('DebugViewer1: initialize()');
                $('#debug1-read').click(() => this.refresh());
            },

            activate: function() {
                console.log('DebugViewer1: activate()');
            },

            canDeactivate: function() {
                console.log('DebugViewer1: canDeactivate() -> true');
                return true;
            },

            deactivate: function() {
                console.log('DebugViewer1: deactivate()');
            },

            refresh: function() {
                console.log('DebugViewer1: refresh()');
                const address = 0x0400; // Screen memory
                const length = 256;

                readMemory(address, length, (data) => {
                    const bytes = new Uint8Array(data);
                    let output = 'Memory dump from $0400 (256 bytes):\n\n';

                    for (let i = 0; i < bytes.length; i += 16) {
                        const addr = (address + i).toString(16).padStart(4, '0').toUpperCase();
                        output += `$${addr}: `;

                        // Hex bytes
                        for (let j = 0; j < 16 && i + j < bytes.length; j++) {
                            output += bytes[i + j].toString(16).padStart(2, '0').toUpperCase() + ' ';
                        }

                        output += '\n';
                    }

                    $('#debug1-display').text(output).show();
                }, (error) => {
                    $('#debug1-display').text(`Error: ${error}`).show();
                });
            }
        };

        // ============================================================================
        // DEBUG VIEWER 2: Parameterized Read
        // ============================================================================

        var DebugViewer2 = {
            initialize: function() {
                console.log('DebugViewer2: initialize()');
                $('#debug2-read').click(() => this.refresh());
            },

            activate: function() {
                console.log('DebugViewer2: activate()');
            },

            canDeactivate: function() {
                console.log('DebugViewer2: canDeactivate() -> true');
                return true;
            },

            deactivate: function() {
                console.log('DebugViewer2: deactivate()');
            },

            refresh: function() {
                console.log('DebugViewer2: refresh()');
                const addressStr = $('#debug2-address').val().replace(/[^0-9A-Fa-f]/g, '');
                const address = parseInt(addressStr, 16);

                if (isNaN(address) || address < 0 || address > 0xFFFF) {
                    showError('Invalid address. Enter hex value (0000-FFFF)');
                    return;
                }

                readMemory(address, 16, (data) => {
                    const bytes = new Uint8Array(data);
                    const addr = address.toString(16).padStart(4, '0').toUpperCase();
                    let output = `Memory at $${addr} (16 bytes):\n\n`;
                    output += `$${addr}: `;

                    for (let i = 0; i < bytes.length; i++) {
                        output += bytes[i].toString(16).padStart(2, '0').toUpperCase() + ' ';
                    }

                    $('#debug2-display').text(output).show();
                }, (error) => {
                    $('#debug2-display').text(`Error: ${error}`).show();
                });
            }
        };

        // ============================================================================
        // DEBUG VIEWER 3: Write Test with Confirmation
        // ============================================================================

        var DebugViewer3 = {
            hasUnsavedChanges: false,

            initialize: function() {
                console.log('DebugViewer3: initialize()');
                $('#debug3-write').click(() => this.writeValue());
                $('#debug3-post-write').click(() => this.writeMultipleBytes());
            },

            activate: function() {
                console.log('DebugViewer3: activate()');
            },

            canDeactivate: function() {
                console.log(`DebugViewer3: canDeactivate() -> hasUnsavedChanges=${this.hasUnsavedChanges}`);
                if (this.hasUnsavedChanges) {
                    const confirmed = confirm('You have written data. Are you sure you want to leave this tab?');
                    if (confirmed) {
                        this.hasUnsavedChanges = false;
                        return true;
                    }
                    return false;
                }
                return true;
            },

            deactivate: function() {
                console.log('DebugViewer3: deactivate()');
            },

            refresh: function() {
                console.log('DebugViewer3: refresh() - not implemented for this viewer');
            },

            writeValue: function() {
                const addressStr = $('#debug3-address').val().replace(/[^0-9A-Fa-f]/g, '');
                const address = parseInt(addressStr, 16);

                const valueStr = $('#debug3-value').val().replace(/[^0-9A-Fa-f]/g, '');
                const value = parseInt(valueStr, 16);

                if (isNaN(address) || address < 0 || address > 0xFFFF) {
                    showError('Invalid address. Enter hex value (0000-FFFF)');
                    return;
                }

                if (isNaN(value) || value < 0 || value > 0xFF) {
                    showError('Invalid value. Enter hex byte (00-FF)');
                    return;
                }

                writeMemory(address, [value], () => {
                    const addr = address.toString(16).padStart(4, '0').toUpperCase();
                    const val = value.toString(16).padStart(2, '0').toUpperCase();
                    $('#debug3-status').html(`<span style="color: var(--success);">✓ Successfully wrote $${val} to address $${addr}</span>`);
                    this.hasUnsavedChanges = true;
                }, (error) => {
                    $('#debug3-status').html(`<span style="color: var(--danger);">✗ Write failed: ${error}</span>`);
                });
            },

            writeMultipleBytes: function() {
                const addressStr = $('#debug3-post-address').val().replace(/[^0-9A-Fa-f]/g, '');
                const address = parseInt(addressStr, 16);

                const valueStr = $('#debug3-post-value').val().replace(/[^0-9A-Fa-f]/g, '');
                const value = parseInt(valueStr, 16);

                const countStr = $('#debug3-post-count').val().replace(/[^0-9]/g, '');
                const count = parseInt(countStr, 10);

                if (isNaN(address) || address < 0 || address > 0xFFFF) {
                    showError('Invalid address. Enter hex value (0000-FFFF)');
                    return;
                }

                if (isNaN(value) || value < 0 || value > 0xFF) {
                    showError('Invalid value. Enter hex byte (00-FF)');
                    return;
                }

                if (isNaN(count) || count < 1 || count > 65536) {
                    showError('Invalid count. Enter value (1-65536)');
                    return;
                }

                // Create array filled with the value
                const dataArray = new Array(count).fill(value);

                writeMemory(address, dataArray, () => {
                    const addr = address.toString(16).padStart(4, '0').toUpperCase();
                    const val = value.toString(16).padStart(2, '0').toUpperCase();
                    const method = count > 128 ? 'POST' : 'PUT';
                    $('#debug3-post-status').html(`<span style="color: var(--success);">✓ Successfully wrote ${count} bytes of $${val} to $${addr} (${method} method)</span>`);
                    this.hasUnsavedChanges = true;
                }, (error) => {
                    $('#debug3-post-status').html(`<span style="color: var(--danger);">✗ Write failed: ${error}</span>`);
                });
            }
        };

        // ============================================================================
        // INITIALIZATION
        // ============================================================================

        // ============================================================================
        // INITIALIZATION
        // ============================================================================

        window.initializeApp = function() {
            console.log('=== Ultimate Memory Browser Tool Initializing ===');

            // Initialize all tabs
            initializeTabs(['HexViewer', 'DisassemblyViewer', 'DebugViewer1', 'DebugViewer2', 'DebugViewer3']);

            // Set up tab system
            setupTabs(tabMap, 'tab0');

            // Activate first tab
            HexViewer.activate();

            // Set up Refresh button
            $('#refreshBtn').click(function() {
                const activeTab = getActiveTab();
                if (activeTab && activeTab.refresh) {
                    activeTab.refresh();
                }
            });

            // Handle page unload - check for unsaved changes
            window.addEventListener('beforeunload', function(e) {
                const activeTab = getActiveTab();
                if (activeTab && activeTab.canDeactivate && !activeTab.canDeactivate()) {
                    e.preventDefault();
                    e.returnValue = '';
                    return '';
                }
            });

            console.log('=== Initialization Complete ===');
        };
    </script>
</body>
</html>
