<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Memory Browser Tool</title>
    <link id="app-favicon" rel="icon" href="data:,">

    <!-- Local requests section ---->
    <!-- --------------------------->

    <script>
    // Fonts: objects (url + font metadata)
    var requiredFonts = [
      {
        url: "fonts/C64ProMono.woff2",
        family: "C64ProMono",
        weight: "normal",
        style: "normal",
        display: "swap",
        format: "woff2"
      }
    ];

    // CSS: objects with url
    var requiredCSS = [
      { url: "css/mem-tools.css" }
    ];

    // JS: objects with url
    var requiredJS = [
      { url: "js/ui-components.js" },
      { url: "js/api-client.js" },
      { url: "js/tab-lifecycle.js" },
      { url: "js/hex-editor.js" },
      { url: "js/disasm-editor.js" },
      { url: "js/screen-viewer.js" }
    ];

    // UI selectors to disable during load
    var contentItems = [
      ".tab-content",
      ".tab-bar"
    ];
    </script>

    <!-- External requests section ---->
    <!-- ------------------------------>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- CommonJS shim for 6502-reasm library -->
    <script>
        var module = { exports: {} };
    </script>

    <!-- Load 6502-reasm library from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/6502-reasm@1.0.0/6502.min.js"></script>

    <!-- Make library globally accessible -->
    <script>
        window.reasm6502 = module.exports;
    </script>

    <!-- Inline CSS Syles section ---->
    <!-- ----------------------------->

    <style>
    /* common-inline.css - Shared styles for C64U Web Control Panel */

    :root {
        /* Colors */
        --primary: #3498db;
        --success: #2ecc71;
        --danger: #e74c3c;
        --warning: #ff9800;
        --bg: #1a1c1e;
        --card-bg: #25282c;
        --text: #e0e0e0;
        --text-dim: #a0a0a0;
        --border: #3a3f44;
        --input-bg: #2d3136;

        /* Spacing */
        --spacing-xs: 5px;
        --spacing-sm: 10px;
        --spacing-md: 20px;
        --spacing-lg: 30px;

        /* Border Radius */
        --radius-sm: 4px;
        --radius-md: 8px;

        /* Transitions */
        --transition: all 0.2s ease;
    }

    /* Base Styles */
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg);
        margin: 0;
        padding: var(--spacing-md);
        color: var(--text);
    }

    .container {
        max-width: 1000px;
        margin: 0 auto;
    }

    /* Header Components */
    header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
        border-bottom: 2px solid var(--primary);
        padding-bottom: var(--spacing-sm);
    }

    h1 {
        margin: 0;
        font-size: 24px;
        color: var(--primary);
    }

    .back-link {
        font-size: 12px;
        color: var(--text-dim);
        text-decoration: none;
        margin-top: var(--spacing-xs);
        display: inline-block;
    }

    .back-link:hover {
        color: var(--primary);
    }

    .header-actions {
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
    }

    /* Authentication Box */
    .auth-box {
        /* No background or border - just contains the password input */
    }

    .auth-password-input {
        width: 120px;
        border: none;
        background: transparent;
        padding: 0;
        color: var(--text);
        font-family: monospace;
    }

    /* Loading Spinner */
    .spinner {
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 3px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Error/Success Messages */
    .error-box {
        display: none;
        background: var(--danger);
        color: white;
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        margin-bottom: 15px;
        font-weight: bold;
        cursor: pointer;
    }

    .success-message {
        color: var(--success);
    }

    .error-message {
        color: var(--danger);
    }

    /* Tab Components */
    .tab-bar {
        display: flex;
        gap: var(--spacing-xs);
        margin-bottom: var(--spacing-md);
        border-bottom: 2px solid var(--border);
    }

    .tab-button {
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--input-bg);
        color: var(--text-dim);
        border: none;
        border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        cursor: pointer;
        font-weight: bold;
        border: 1px solid var(--border);
        border-bottom: none;
        transition: var(--transition);
    }

    .tab-button:hover {
        background: var(--card-bg);
        color: var(--text);
    }

    .tab-button.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .tab-content {
        background: var(--card-bg);
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
        padding: var(--spacing-md);
        min-height: 400px;
    }

    .tab-content.content-hidden {
        visibility: hidden;
    }

    /* Form Controls */
    input[type="text"],
    input[type="password"],
    select {
        padding: 8px;
        background: var(--input-bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--text);
        font-family: monospace;
    }

    select {
        cursor: pointer;
    }

    input:focus,
    select:focus {
        outline: none;
        border-color: var(--primary);
    }

    input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
    }

    input[type="checkbox"]:focus {
        outline: none;
        border-color: var(--primary);
    }

    label {
        color: var(--text-dim);
        font-weight: bold;
    }

    /* Buttons */
    button {
        padding: 8px 16px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-weight: bold;
        transition: var(--transition);
    }

    button:hover {
        opacity: 0.8;
    }

    .btn-primary { background: var(--primary); }
    .btn-success { background: var(--success); }
    .btn-danger { background: var(--danger); }
    .btn-warning { background: var(--warning); }

    /* Control Groups */
    .control-group {
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
        margin-bottom: 15px;
    }

    .control-group label {
        color: var(--text-dim);
        font-weight: bold;
    }

    .control-group input {
        width: 100px;
    }

    /* Info/Status Boxes */
    .info-box {
        background: rgba(255, 255, 255, 0.05);
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        margin-bottom: 15px;
        font-size: 12px;
        color: var(--text-dim);
    }

    /* Console/Code Display */
    .console-display {
        background: #121416;
        color: #7fdbff;
        padding: 15px;
        border-radius: var(--radius-sm);
        font-family: monospace;
        font-size: 13px;
        white-space: pre;
        overflow-x: auto;
        margin-top: 15px;
        border: 1px solid #333;
    }

    .code-display {
        background: var(--input-bg);
        color: var(--text);
        padding: 15px;
        border-radius: var(--radius-sm);
        font-family: monospace;
        font-size: 13px;
        white-space: pre;
        overflow-x: auto;
        border: 1px solid var(--border);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        body {
            padding: var(--spacing-sm);
        }

        header {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--spacing-sm);
        }

        .header-actions {
            width: 100%;
            justify-content: space-between;
        }

        .tab-bar {
            flex-wrap: wrap;
        }

        .control-group {
            flex-wrap: wrap;
        }
    }

    /* Content Disabled State - Used during script loading */
    .content-disabled {
        filter: grayscale(100%) brightness(0.8);
        opacity: 0.6;
        pointer-events: none;
    }

    /* Input Disabled State */
    .input-disabled {
        opacity: 0.4;
        pointer-events: none;
    }

    /* Modal Dialog Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-dialog {
        background: var(--card-bg);
        border: 2px solid var(--border);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        min-width: 400px;
        max-width: 600px;
    }

    .modal-instructions {
        color: var(--text-dim);
        font-size: 14px;
        margin-bottom: var(--spacing-sm);
    }

    .modal-textarea {
        width: 100%;
        height: 100px;
        background: var(--input-bg);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 8px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        resize: vertical;
        margin-bottom: var(--spacing-md);
        box-sizing: border-box;
    }

    .modal-textarea:focus {
        outline: none;
        border-color: var(--primary);
    }

    .modal-buttons {
        display: flex;
        gap: var(--spacing-sm);
        justify-content: flex-end;
    }

    /* Card Styles */
    .card {
        background: var(--card-bg);
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
        padding: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .card-title {
        font-weight: bold;
        font-size: 18px;
        margin-bottom: 15px;
        color: var(--primary);
        border-bottom: 1px solid var(--border);
        padding-bottom: 5px;
    }

    .card-subtitle {
        font-size: 13px;
        color: var(--text-dim);
        margin-bottom: 15px;
        font-style: italic;
    }

    /* Grid Layouts */
    .grid-7-3 {
        display: grid;
        grid-template-columns: 7fr 3fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .grid-50-50 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    /* Foldable Section Styles */
    .foldable {
        margin-bottom: 15px;
    }

    .foldable-header {
        background: #2c3136;
        padding: 12px 15px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: var(--primary);
        border: 1px solid var(--border);
        border-bottom: none;
        border-radius: var(--radius-md) var(--radius-md) 0 0;
    }

    .foldable-header:hover {
        background: #32383e;
    }

    .foldable-header .arrow {
        transition: transform 0.2s;
    }

    .foldable-header .spinner {
        display: none;
        margin-left: 10px;
    }

    .foldable-header .caption {
        color: var(--text-dim);
        font-weight: normal;
        font-size: 13px;
        margin-left: 5px;
    }

    .foldable-content {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-top: none;
        border-radius: 0 0 var(--radius-md) var(--radius-md);
        padding: 15px;
        display: none;
    }

    .foldable-content.loading {
        display: block;
        text-align: center;
        color: var(--text-dim);
        font-style: italic;
    }

    /* Status Item Styles */
    .status-grid {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .status-item {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        padding: 6px 0;
    }

    .status-label {
        color: var(--text-dim);
        font-weight: bold;
    }

    .status-value {
        font-family: monospace;
        color: var(--text);
    }

    /* Button with Glyph */
    .btn-glyph {
        font-size: 16px;
        margin-right: 4px;
    }

    /* Tool Button */
    .tool-btn {
        padding: 12px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        display: block;
        transition: opacity 0.2s, transform 0.1s;
    }

    .tool-btn:hover {
        opacity: 0.8;
        transform: translateY(-1px);
    }

    .tool-btn:active {
        transform: translateY(0);
    }

    /* Tools Grid */
    .tools-grid {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 15px;
    }
    </style>

    <!-- Inline JS Scripts section ---->
    <!-- ------------------------------>

    <script>
    /* common-inline.js
     * No Concurrent File Load (sequential): CSS -> Fonts -> JS -> Favicon
     *
     * Per-page globals (define BEFORE this runs):
     *   var requiredFonts = [{ url, family, weight, style, display?, format? }, ...];
     *   var requiredCSS   = [{ url }, ...];
     *   var requiredJS    = [{ url }, ...];
     *   var contentItems  = ['.selector', ...];
     *
     * Optional:
     *   window.initializeApp()
     */

    (function () {
      'use strict';

      // ----------------------------
      // Defaults (if page forgets)
      // ----------------------------
      if (!Array.isArray(window.requiredFonts)) window.requiredFonts = [];
      if (!Array.isArray(window.requiredCSS)) window.requiredCSS = [];
      if (!Array.isArray(window.requiredJS)) window.requiredJS = [];
      if (!Array.isArray(window.contentItems)) window.contentItems = [];

      // ----------------------------
      // UI helpers
      // ----------------------------
      function showSpinner() {
        var spinner = document.getElementById('spinner');
        if (spinner) spinner.style.display = 'inline-block';
      }

      function hideSpinner() {
        var spinner = document.getElementById('spinner');
        if (spinner) spinner.style.display = 'none';
      }

      function disableContent() {
        window.contentItems.forEach(function (selector) {
          var el = document.querySelector(selector);
          if (el) el.classList.add('content-disabled');
        });
      }

      function enableContent() {
        window.contentItems.forEach(function (selector) {
          var el = document.querySelector(selector);
          if (el) {
            el.classList.remove('content-disabled');
            el.classList.remove('content-hidden');
            }
        });
      }

      function showCriticalError(message, fileUrl) {
        hideSpinner(); // keep content disabled

        var text = '❌ ' + message + (fileUrl ? (' (' + fileUrl + ')') : '') + ' Please reload.';

        var host = document.querySelector('.header-actions') || document.body;

        var existing = document.getElementById('critical-error-inline');
        if (existing) {
          existing.textContent = text;
          return;
        }

        var span = document.createElement('span');
        span.id = 'critical-error-inline';
        span.textContent = text;
        span.style.cssText =
          'color:#e74c3c;font-weight:bold;font-size:14px;margin-right:25px;';

        if (host.firstChild) host.insertBefore(span, host.firstChild);
        else host.appendChild(span);
      }

      // Optional exports
      window.showSpinner = showSpinner;
      window.hideSpinner = hideSpinner;
      window.disableContent = disableContent;
      window.enableContent = enableContent;
      window.showCriticalError = showCriticalError;

      // ----------------------------
      // Favicon stage (best-effort, last)
      // ----------------------------

      function ensurePlaceholderFaviconLink() {
        var link = document.getElementById('app-favicon');
        if (!link) {
          link = document.createElement('link');
          link.id = 'app-favicon';
          link.rel = 'icon';
          document.head.appendChild(link);
        }
        if (!link.href) link.href = 'data:,';
        return link;
      }

      function setFaviconHref(url) {
        var link = ensurePlaceholderFaviconLink();
        link.href = url;
      }

      // Best-effort: if favicon.ico exists next to the HTML file, set it.
      // Do nothing on any failure.
      function tryLoadFaviconLast() {
        // Skip on file:// protocol (CORS blocks fetch)
        if (window.location.protocol === 'file:') {
          return Promise.resolve();
        }

        ensurePlaceholderFaviconLink();

        var url = 'favicon.ico';

        // Use HEAD probe to avoid downloading it; fallback to GET if HEAD fails.
        return fetch(url, { method: 'HEAD', cache: 'no-store' })
          .then(function (r) {
            if (r && r.ok) setFaviconHref(url);
          })
          .catch(function () {
            return fetch(url, { method: 'GET', cache: 'no-store' })
              .then(function (r) {
                if (r && r.ok) setFaviconHref(url);
              })
              .catch(function () { /* ignore */ });
          });
      }

      // ----------------------------
      // Sequential loaders
      // ----------------------------

      function loadCSSSequential(list) {
        if (!list.length) return Promise.resolve();

        var i = 0;

        function next() {
          if (i >= list.length) return Promise.resolve();

          var item = list[i++];
          var url = item && item.url;

          if (!url) {
            return Promise.reject({ stage: 'css', url: null, error: new Error('Invalid CSS spec') });
          }

          return new Promise(function (resolve, reject) {
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = url;

            link.onload = function () { resolve(); };
            link.onerror = function () { reject(new Error('CSS load error')); };

            document.head.appendChild(link);
          }).then(next).catch(function (e) {
            return Promise.reject({ stage: 'css', url: url, error: e });
          });
        }

        return next();
      }

      function loadFontsSequential(list) {
        if (!list.length) return Promise.resolve();

        if (!('FontFace' in window) || !document.fonts) {
          // Non-fatal: allow fallback fonts
          return Promise.resolve();
        }

        var i = 0;

        function next() {
          if (i >= list.length) return Promise.resolve();

          var f = list[i++];
          if (!f || !f.url || !f.family) {
            return Promise.reject({ stage: 'font', url: (f && f.url) || null, error: new Error('Invalid font spec') });
          }

          var descriptors = {
            weight: f.weight || 'normal',
            style: f.style || 'normal'
          };
          if (f.display) descriptors.display = f.display;

          var face = new FontFace(
            f.family,
            "url('" + f.url + "')" + (f.format ? (" format('" + f.format + "')") : ''),
            descriptors
          );

          return face.load().then(function (loaded) {
            document.fonts.add(loaded);
            return next();
          }).catch(function (e) {
            return Promise.reject({ stage: 'font', url: f.url, error: e });
          });
        }

        return next();
      }

      function loadJSSequential(list) {
        if (!list.length) return Promise.resolve();

        var i = 0;

        function next() {
          if (i >= list.length) return Promise.resolve();

          var item = list[i++];
          var url = item && item.url;

          if (!url) {
            return Promise.reject({ stage: 'js', url: null, error: new Error('Invalid JS spec') });
          }

          return new Promise(function (resolve, reject) {
            var script = document.createElement('script');
            script.src = url;

            var hadErrorForThisScript = false;

            function onWindowError(event) {
              if (event && event.filename && event.filename.indexOf(url) !== -1) {
                hadErrorForThisScript = true;
              }
            }

            window.addEventListener('error', onWindowError);

            script.onload = function () {
              setTimeout(function () {
                window.removeEventListener('error', onWindowError);
                if (hadErrorForThisScript) reject(new Error('JS syntax/runtime error'));
                else resolve();
              }, 50);
            };

            script.onerror = function () {
              window.removeEventListener('error', onWindowError);
              reject(new Error('JS network error'));
            };

            document.head.appendChild(script);
          }).then(next).catch(function (e) {
            return Promise.reject({ stage: 'js', url: url, error: e });
          });
        }

        return next();
      }

      // ----------------------------
      // Orchestrator + boot
      // ----------------------------

      function loadAllSequentially() {
        // Favicon is last and best-effort: never fails the pipeline.
        return loadCSSSequential(window.requiredCSS)
          .then(function () { return loadFontsSequential(window.requiredFonts); })
          .then(function () { return loadJSSequential(window.requiredJS); })
          .then(function () { return tryLoadFaviconLast().catch(function () { /* ignore */ }); });
      }

      function startPageLoad() {
        showSpinner();
        disableContent();

        loadAllSequentially()
          .then(function () {
            hideSpinner();
            enableContent();

            if (typeof window.initializeApp === 'function') {
              window.initializeApp();
            }
          })
          .catch(function (info) {
            var stage = (info && info.stage) ? info.stage : 'unknown';
            var url = (info && info.url) ? info.url : null;

            showCriticalError('Failed to load local ' + stage + ' resource.', url);
            console.error('Critical load failure:', info);
          });
      }

      if (window.jQuery && typeof window.jQuery === 'function') {
        jQuery(document).ready(function () {
          setTimeout(startPageLoad, 25);
        });
      } else {
        document.addEventListener('DOMContentLoaded', function () {
          setTimeout(startPageLoad, 25);
        });
      }
    })();
    </script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div>
                <h1>Ultimate Memory Browser Tool</h1>
                <a href="/" class="back-link">← Back to Control Panel</a>
            </div>
            <div class="header-actions">
                <span id="spinner" class="spinner" style="display:none;"></span>
                <button id="refreshBtn" class="btn-success">Refresh</button>
                <div class="auth-box">
                    <form autocomplete="on">
                        <input type="text" name="username" value="ultimate-api" autocomplete="username" style="display: none;">
                        <input type="password" id="apiPassword" name="password" placeholder="API Password" autocomplete="current-password" class="auth-password-input">
                    </form>
                </div>
            </div>
        </header>

        <!-- Error Box -->
        <div id="errorBox" class="error-box"></div>

        <!-- Tab Bar -->
        <div class="tab-bar content-disabled">
            <button class="tab-button active" data-tab="tab0">Hex Viewer</button>
            <button class="tab-button" data-tab="tab1">Disassembly</button>
            <button class="tab-button" data-tab="tab2">Screen</button>
        </div>

        <!-- Hex Viewer: Memory Browser -->
        <div id="tab0-content" class="tab-content content-hidden">
            <!-- Hex Viewer Header -->
            <div class="mem-header">
                <div class="mem-header-left">
                    <label>Address:</label>
                    <input type="text" id="hex-address" value="0400" placeholder="0400" class="mem-input-address">

                    <label>Page Size:</label>
                    <select id="hex-pagesize" class="mem-select">
                        <option value="128">128</option>
                        <option value="256" selected>256</option>
                        <option value="512">512</option>
                        <option value="1024">1024</option>
                    </select>

                    <label>Charset:</label>
                    <select id="hex-charset" class="mem-select">
                        <option value="0xEE00" selected>Screen 1</option>
                        <option value="0xEF00">Screen 2</option>
                        <option value="0xE000">PETSCII 1</option>
                        <option value="0xE100">PETSCII 2</option>
                    </select>
                </div>

                <div class="mem-header-right">
                    <button class="mem-nav-btn" id="mem-nav-up" title="Up">▲</button>
                    <button class="mem-nav-btn" id="mem-nav-down" title="Down">▼</button>
                    <button class="mem-nav-btn" id="mem-nav-left" title="Left">◄</button>
                    <button class="mem-nav-btn" id="mem-nav-right" title="Right">►</button>
                    <button class="mem-nav-btn mem-nav-page" id="hex-prev-page">Prev Page</button>
                    <button class="mem-nav-btn mem-nav-page" id="hex-next-page">Next Page</button>
                </div>
            </div>

            <!-- Hex Viewer Sub-header -->
            <div class="mem-subheader">
                <div class="mem-subheader-left">
                    <span id="hex-current-address">$0400 (1024) - $04FF (1279)</span>
                </div>
                <div class="mem-subheader-right">
                    <button class="btn-primary" id="hex-edit-btn" style="display:inline-block;">Edit</button>
                    <button class="btn-success" id="hex-save-btn" style="display:none;">Save</button>
                    <button class="btn-danger" id="hex-cancel-btn" style="display:none;">Cancel</button>
                </div>
            </div>

            <!-- Hex Viewer Memory Display -->
            <div class="hex-display" id="hex-display">
                <!-- Placeholder data will be generated here -->
            </div>
        </div>

        <!-- Disassembly Viewer: 6502 Assembly Browser -->
        <div id="tab1-content" class="tab-content" style="display:none;">
            <!-- Disassembly Viewer Header -->
            <div class="mem-header">
                <div class="mem-header-left">
                    <label>Address:</label>
                    <input type="text" id="disasm-address" value="C000" placeholder="C000" class="mem-input-address">

                    <label>Length:</label>
                    <select id="disasm-length" class="mem-select">
                        <option value="32">32</option>
                        <option value="48" selected>48</option>
                        <option value="64">64</option>
                        <option value="128">128</option>
                    </select>

                    <label class="mem-checkbox-label">
                        <input type="checkbox" id="disasm-show-all">
                        All opcodes
                    </label>
                </div>

                <div class="mem-header-right">
                    <button class="mem-nav-btn" id="disasm-nav-up" title="Up">▲</button>
                    <button class="mem-nav-btn" id="disasm-nav-down" title="Down">▼</button>
                    <button class="mem-nav-btn mem-nav-page" id="disasm-prev-page">Prev Page</button>
                    <button class="mem-nav-btn mem-nav-page" id="disasm-next-page">Next Page</button>
                </div>
            </div>

            <!-- Disassembly Viewer Sub-header -->
            <div class="mem-subheader">
                <div class="mem-subheader-left">
                    <span id="disasm-current-address">$C000 (49152) - $C03F (49215)</span>
                </div>
                <div class="mem-subheader-right">
                    <button class="btn-primary" id="disasm-edit-btn" style="display:inline-block;">Edit</button>
                    <button class="btn-primary" id="disasm-paste-asm-btn" style="display:none;">Paste Asm</button>
                    <button class="btn-success" id="disasm-save-btn" style="display:none; margin-left: 8px;">Save</button>
                    <button class="btn-danger" id="disasm-cancel-btn" style="display:none;">Cancel</button>
                </div>
            </div>

            <!-- Disassembly Viewer Memory Display -->
            <div class="disasm-display" id="disasm-display">
                <!-- Disassembly data will be generated here -->
            </div>
        </div>

        <!-- Screen Viewer: C64 Screen Display -->
        <div id="tab2-content" class="tab-content" style="display:none;">
            <!-- Screen Viewer Header -->
            <div class="mem-header">
                <div class="mem-header-left">
                    <label>Address:</label>
                    <input type="text" id="screen-address" value="0400" placeholder="0400" class="mem-input-address">

                    <label>Charset:</label>
                    <select id="screen-charset" class="mem-select">
                        <option value="0xEE00" selected>Screen 1</option>
                        <option value="0xEF00">Screen 2</option>
                        <option value="0xE000">PETSCII 1</option>
                        <option value="0xE100">PETSCII 2</option>
                    </select>

                    <label class="mem-checkbox-label">
                        <input type="checkbox" id="screen-auto-refresh">
                        Auto-refresh
                    </label>
                </div>

                <div class="mem-header-right">
                    <button class="mem-nav-btn" id="screen-nav-up" title="Up">▲</button>
                    <button class="mem-nav-btn" id="screen-nav-down" title="Down">▼</button>
                    <button class="mem-nav-btn" id="screen-nav-left" title="Left">◄</button>
                    <button class="mem-nav-btn" id="screen-nav-right" title="Right">►</button>
                    <button class="mem-nav-btn mem-nav-page" id="screen-prev-page">Prev Page</button>
                    <button class="mem-nav-btn mem-nav-page" id="screen-next-page">Next Page</button>
                </div>
            </div>

            <!-- Screen Viewer Sub-header -->
            <div class="mem-subheader">
                <div class="mem-subheader-left">
                    <span id="screen-current-address">$0400 (1024) - $07D3 (2015)</span>
                </div>
            </div>

            <!-- Screen Viewer Display -->
            <div class="screen-display" id="screen-display">
                <!-- Screen grid will be generated here -->
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // TAB MANAGEMENT (using tab-lifecycle.js)
        // ============================================================================

        const tabMap = {
            'tab0': 'HexViewer',
            'tab1': 'DisassemblyViewer',
            'tab2': 'ScreenViewer'
        };

        // ============================================================================
        // HEX VIEWER: Memory Browser (using hex-editor.js)
        // ============================================================================

        var HexViewer = {
            initialize: function() {
                console.log('HexViewer: initialize()');

                // Initialize hex editor with empty data first
                const initialAddress = parseInt($('#hex-address').val(), 16) || 0x0400;
                const initialPageSize = parseInt($('#hex-pagesize').val()) || 256;
                const emptyData = new Uint8Array(initialPageSize);
                hexEditorInit($('#hex-display'), initialAddress, emptyData);

                // Set up mouse handlers
                hexEditorSetupMouse();

                // Set navigation callback for keyboard navigation
                hexEditorSetNavigationCallback(() => this.updateAddressDisplay());

                // Set up navigation controls
                this.setupNavigation();

                // Set up Edit/Save/Cancel buttons
                const enterEditMode = () => {
                    // Don't enter edit mode if API is busy
                    if (isApiBusy()) {
                        return;
                    }
                    hexEditorEnterEditMode();
                    $('#hex-edit-btn').hide();
                    $('#hex-save-btn, #hex-cancel-btn').show();
                    this.updateAddressDisplay();
                };

                const saveChanges = () => {
                    // Save changes using hex-editor.js function
                    hexEditorSaveChanges(
                        () => {
                            // Success: exit edit mode (callback handles UI)
                            hexEditorExitEditMode(true);

                            // Reload memory to show saved state
                            const currentAddress = hexEditorState.startAddress;
                            hexEditorNavigateToAddress(currentAddress, () => {
                                this.updateAddressDisplay();
                            });
                        },
                        (errorMsg) => {
                            // Error: stay in edit mode (error already displayed)
                            console.error('Save failed:', errorMsg);
                        }
                    );
                };

                handleButtonClick('hex-edit-btn', enterEditMode);
                handleButtonClick('hex-save-btn', saveChanges);

                // Set keyboard shortcut callbacks
                hexEditorSetEnterEditModeCallback(enterEditMode);
                hexEditorSetSaveCallback(saveChanges);
                hexEditorSetExitEditModeCallback((save) => {
                    $('#hex-save-btn, #hex-cancel-btn').hide();
                    $('#hex-edit-btn').show();
                    this.updateAddressDisplay();
                });

                handleButtonClick('hex-cancel-btn', () => {
                    // Check if there are unsaved changes
                    if (hexEditorIsModified()) {
                        if (!confirm('Discard all changes?')) {
                            return; // User canceled, stay in edit mode
                        }
                    }

                    hexEditorExitEditMode(false); // save = false (cancel) - callback handles UI
                });
            },

            setupNavigation: function() {
                // Address input - navigate on Enter
                $('#hex-address').on('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();

                        if (isApiBusy()) {
                            return;
                        }

                        const address = parseAddressInput('hex-address');

                        if (address === null) {
                            alert('Invalid address. Please enter a hex value between 0000 and FFFF.');
                            return;
                        }

                        hexEditorNavigateToAddress(address, () => {
                            this.updateAddressDisplay();
                        });
                    }
                });

                // Page size selector - reload data with new page size
                handleInputChange('hex-pagesize', (value) => {
                    const pageSize = parseInt(value);
                    hexEditorSetPageSize(pageSize);

                    // Validate current address with new page size
                    const currentAddress = hexEditorValidateAddress(hexEditorState.startAddress, pageSize);

                    // Reload data at (possibly adjusted) address with new page size
                    hexEditorNavigateToAddress(currentAddress, () => {
                        this.updateAddressDisplay();
                    });
                });

                // Charset selector - update character display
                handleInputChange('hex-charset', (value) => {
                    const puaBase = parseInt(value);
                    hexEditorSetCharsetPuaBase(puaBase);

                    // Re-render display to show new charset
                    hexEditorRender();
                });

                // Navigation buttons
                handleButtonClick('mem-nav-up', () => {
                    if (isApiBusy()) return;
                    hexEditorNavigateUp(() => this.updateAddressDisplay());
                });

                handleButtonClick('mem-nav-down', () => {
                    if (isApiBusy()) return;
                    hexEditorNavigateDown(() => this.updateAddressDisplay());
                });

                handleButtonClick('mem-nav-left', () => {
                    if (isApiBusy()) return;
                    hexEditorNavigateLeft(() => this.updateAddressDisplay());
                });

                handleButtonClick('mem-nav-right', () => {
                    if (isApiBusy()) return;
                    hexEditorNavigateRight(() => this.updateAddressDisplay());
                });

                handleButtonClick('hex-prev-page', () => {
                    if (isApiBusy()) return;
                    hexEditorNavigatePrevPage(() => this.updateAddressDisplay());
                });

                handleButtonClick('hex-next-page', () => {
                    if (isApiBusy()) return;
                    hexEditorNavigateNextPage(() => this.updateAddressDisplay());
                });
            },

            updateAddressDisplay: function() {
                const range = hexEditorGetAddressRange();
                const startHex = formatHexWord(range.startAddress);
                const endHex = formatHexWord(range.endAddress);

                // Update address input to match current address
                $('#hex-address').val(startHex);

                // Update address display
                $('#hex-current-address').text(
                    `$${startHex} (${range.startAddress}) - $${endHex} (${range.endAddress})`
                );
            },

            activate: function() {
                console.log('HexViewer: activate()');
                this.refresh();
            },

            canDeactivate: function() {
                console.log('HexViewer: canDeactivate()');
                // Check if in edit mode with unsaved changes
                if (hexEditorState.editMode && hexEditorIsModified()) {
                    return confirm('You have unsaved changes. Leave anyway?');
                }
                return true;
            },

            deactivate: function() {
                console.log('HexViewer: deactivate()');
                // Force exit edit mode when switching tabs (discard any changes)
                // Callback will handle UI updates
                hexEditorExitEditMode(false);
            },

            refresh: function() {
                console.log('HexViewer: refresh()');
                // Don't refresh if API is busy
                if (isApiBusy()) {
                    return;
                }
                // Reload current memory address
                const currentAddress = hexEditorState.startAddress;
                hexEditorNavigateToAddress(currentAddress, () => {
                    this.updateAddressDisplay();
                });
            },

            handleKeyDown: function(e) {
                return hexEditorHandleKey(e);
            }
        };

        // ============================================================================
        // DISASSEMBLY VIEWER: 6502 Assembly Browser
        // ============================================================================

        var DisassemblyViewer = {
            initialize: function() {
                console.log('DisassemblyViewer: initialize()');

                const initialAddress = parseInt($('#disasm-address').val(), 16) || 0xC000;
                const initialLength = parseInt($('#disasm-length').val()) || 48;
                disasmEditorInit($('#disasm-display'), initialAddress, initialLength);

                disasmEditorSetNavigationCallback(() => this.updateAddressDisplay());

                // Set up mouse handlers
                disasmEditorSetupMouse();

                this.setupNavigation();

                // === EDIT MODE SETUP ===
                const enterEditMode = () => {
                    if (isApiBusy()) {
                        return;
                    }
                    disasmEditorEnterEditMode();
                    $('#disasm-edit-btn').hide();
                    $('#disasm-paste-asm-btn, #disasm-save-btn, #disasm-cancel-btn').show();
                    this.updateAddressDisplay();
                };

                const saveChanges = () => {
                    disasmEditorSaveChanges(
                        () => {
                            // Success: exit edit mode (callback handles UI)
                            disasmEditorExitEditMode(true, false);
                            this.refresh();
                        },
                        (errorMsg) => {
                            console.error('Save failed:', errorMsg);
                        }
                    );
                };

                handleButtonClick('disasm-edit-btn', enterEditMode);
                handleButtonClick('disasm-paste-asm-btn', () => {
                    disasmEditorPasteAsm();
                });
                handleButtonClick('disasm-save-btn', saveChanges);
                handleButtonClick('disasm-cancel-btn', () => {
                    if (disasmEditorIsModified()) {
                        if (!confirm('Discard all changes?')) {
                            return;
                        }
                    }
                    disasmEditorExitEditMode(false, false); // callback handles UI
                });

                // Keyboard shortcuts
                disasmEditorSetEnterEditModeCallback(enterEditMode);
                disasmEditorSetSaveCallback(saveChanges);
                disasmEditorSetExitEditModeCallback((save) => {
                    $('#disasm-paste-asm-btn, #disasm-save-btn, #disasm-cancel-btn').hide();
                    $('#disasm-edit-btn').show();
                    this.updateAddressDisplay();
                });
            },

            setupNavigation: function() {
                $('#disasm-address').on('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();

                        if (isApiBusy()) {
                            return;
                        }

                        const address = parseAddressInput('disasm-address', disasmEditorState.currentLength);

                        if (address === null) {
                            alert('Invalid address. Please enter a hex value between 0000 and FFFF.');
                            return;
                        }

                        disasmEditorNavigateToAddress(address, () => {
                            this.updateAddressDisplay();
                        });
                    }
                });

                handleInputChange('disasm-length', (value) => {
                    const length = parseInt(value);
                    disasmEditorSetLength(length);

                    const currentAddress = validateMemoryAddress(disasmEditorState.startAddress, length);
                    disasmEditorNavigateToAddress(currentAddress, () => {
                        this.updateAddressDisplay();
                    });
                });

                handleButtonClick('disasm-nav-up', () => {
                    if (isApiBusy()) return;
                    disasmEditorNavigateUp(() => this.updateAddressDisplay());
                });

                handleButtonClick('disasm-nav-down', () => {
                    if (isApiBusy()) return;
                    disasmEditorNavigateDown(() => this.updateAddressDisplay());
                });

                handleButtonClick('disasm-prev-page', () => {
                    if (isApiBusy()) return;
                    disasmEditorNavigatePrevPage(() => this.updateAddressDisplay());
                });

                handleButtonClick('disasm-next-page', () => {
                    if (isApiBusy()) return;
                    disasmEditorNavigateNextPage(() => this.updateAddressDisplay());
                });

                handleInputChange('disasm-show-all', (checked) => {
                    disasmEditorSetShowAllOpcodes(checked);
                    disasmEditorLoadAndDisassemble(() => this.updateAddressDisplay());
                });
            },

            updateAddressDisplay: function() {
                const range = disasmEditorGetAddressRange();
                const startHex = formatHexWord(range.startAddress);

                $('#disasm-address').val(startHex);
            },

            activate: function() {
                console.log('DisassemblyViewer: activate()');
                this.refresh();
            },

            canDeactivate: function() {
                console.log('DisassemblyViewer: canDeactivate()');
                if (disasmEditorState.editMode && disasmEditorIsModified()) {
                    return confirm('You have unsaved changes. Leave anyway?');
                }
                return true;
            },

            deactivate: function() {
                console.log('DisassemblyViewer: deactivate()');
                // Force exit edit mode when switching tabs (discard any changes)
                // Skip reload to avoid API call during tab switch
                disasmEditorExitEditMode(false, true);
            },

            refresh: function() {
                console.log('DisassemblyViewer: refresh()');
                if (isApiBusy()) {
                    return;
                }
                const currentAddress = disasmEditorState.startAddress;
                disasmEditorNavigateToAddress(currentAddress, () => {
                    this.updateAddressDisplay();
                });
            },

            handleKeyDown: function(e) {
                return disasmEditorHandleKey(e);
            }
        };

        // ============================================================================
        // SCREEN VIEWER: C64 Screen Display
        // ============================================================================

        var ScreenViewer = {
            initialize: function() {
                console.log('ScreenViewer: initialize()');

                screenViewerInit($('#screen-display'));

                screenViewerSetNavigationCallback(() => this.updateAddressDisplay());

                this.setupNavigation();
            },

            setupNavigation: function() {
                $('#screen-address').on('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();

                        if (isApiBusy()) {
                            return;
                        }

                        const address = parseAddressInput('screen-address');

                        if (address === null) {
                            alert('Invalid address. Please enter a hex value between 0000 and FFFF.');
                            return;
                        }

                        screenViewerNavigateToAddress(address, () => {
                            this.updateAddressDisplay();
                        });
                    }
                });

                handleInputChange('screen-charset', (value) => {
                    const puaBase = parseInt(value);
                    screenViewerSetCharsetPuaBase(puaBase);
                });

                handleButtonClick('screen-nav-up', () => {
                    if (isApiBusy()) return;
                    screenViewerNavigateUp(() => this.updateAddressDisplay());
                });

                handleButtonClick('screen-nav-down', () => {
                    if (isApiBusy()) return;
                    screenViewerNavigateDown(() => this.updateAddressDisplay());
                });

                handleButtonClick('screen-nav-left', () => {
                    if (isApiBusy()) return;
                    screenViewerNavigateLeft(() => this.updateAddressDisplay());
                });

                handleButtonClick('screen-nav-right', () => {
                    if (isApiBusy()) return;
                    screenViewerNavigateRight(() => this.updateAddressDisplay());
                });

                handleButtonClick('screen-prev-page', () => {
                    if (isApiBusy()) return;
                    screenViewerNavigatePrevPage(() => this.updateAddressDisplay());
                });

                handleButtonClick('screen-next-page', () => {
                    if (isApiBusy()) return;
                    screenViewerNavigateNextPage(() => this.updateAddressDisplay());
                });

                handleInputChange('screen-auto-refresh', (checked) => {
                    screenViewerSetAutoRefresh(checked);
                });
            },

            updateAddressDisplay: function() {
                const range = screenViewerGetAddressRange();
                const startHex = formatHexWord(range.startAddress);
                const endHex = formatHexWord(range.endAddress);

                $('#screen-address').val(startHex);

                $('#screen-current-address').text(
                    `$${startHex} (${range.startAddress}) - $${endHex} (${range.endAddress})`
                );
            },

            activate: function() {
                console.log('ScreenViewer: activate()');
                this.refresh(() => {
                    if ($('#screen-auto-refresh').prop('checked')) {
                        screenViewerSetAutoRefresh(true);
                    }
                });
            },

            canDeactivate: function() {
                console.log('ScreenViewer: canDeactivate()');
                return true;
            },

            deactivate: function() {
                console.log('ScreenViewer: deactivate()');
                screenViewerSetAutoRefresh(false);
            },

            refresh: function(callback) {
                console.log('ScreenViewer: refresh()');
                if (isApiBusy()) {
                    return;
                }
                const currentAddress = screenViewerState.address;
                screenViewerNavigateToAddress(currentAddress, () => {
                    this.updateAddressDisplay();
                    if (callback) callback();
                });
            },

            handleKeyDown: function(e) {
                return screenViewerHandleKey(e);
            }
        };

        // ============================================================================
        // INITIALIZATION
        // ============================================================================

        window.initializeApp = function() {
            console.log('=== Ultimate Memory Browser Tool Initializing ===');

            // Initialize tab system
            initializeTabs(tabMap, 'tab0');

            console.log('=== Initialization Complete ===');
        };
    </script>
</body>
</html>
